#pragma once

#include <stdint.h>
#include <stdio.h>
#include <assert.h>

#include "../interop/hcc_interop.h"

// ===========================================
//
//
// General
//
//
// ===========================================

#ifdef __linux__
#define HCC_OS_LINUX
#endif

#ifdef _WIN32
#define HCC_OS_WINDOWS
#endif

#if _WIN32 || _WIN64
#if _WIN64
#define HCC_ARCH_X86_64
#else
#error "32-bit windows is not support"
#endif
#endif

#if defined(__x86_64__)
#define HCC_ARCH_X86_64
#endif

#if defined(__aarch64__)
#define HCC_ARCH_AARCH64
#endif

#ifndef alignof
#define alignof _Alignof
#endif

#ifndef alignas
#define alignas _Alignas
#endif

#ifndef thread_local
#define thread_local _Thread_local
#endif

#ifndef bool
#define bool _Bool
#endif

#ifndef true
#define true 1
#endif

#ifndef false
#define false 0
#endif

#ifndef hcc_max_align_t
#define hcc_max_align_t void*
#endif

#define HCC_DEFINE_ID(Name) typedef struct Name { uint32_t idx_plus_one; } Name
HCC_DEFINE_ID(HccStringId);
HCC_DEFINE_ID(HccConstantId);
#define HccStringId(id) (HccStringId){id}
#define HccConstantId(id) (HccConstantId){id}

typedef struct HccCompiler HccCompiler;
typedef struct HccTask HccTask;
typedef struct HccAST HccAST;
typedef struct HccAML HccAML;
typedef struct HccPPMacro HccPPMacro;
typedef struct HccCodeFile HccCodeFile;
typedef struct HccLocation HccLocation;
typedef struct HccTarget HccTarget;
typedef struct HccCU HccCU;
typedef struct HccASTFile HccASTFile;
typedef struct HccASTVariable HccASTVariable;

// ===========================================
//
//
// Result
//
//
// ===========================================

typedef int16_t HccResultCode;
enum HccResultCode {
	//
	// success codes are positive
	//
	HCC_SUCCESS,
	HCC_SUCCESS_IS_NEW,

	HCC_SUCCESS_COUNT,

	//
	// errors are negative
	//

	HCC_ERROR_ALLOCATION_FAILURE = -10000, // HccResult.value == HccAllocTag
	HCC_ERROR_COLLECTION_FULL,    // HccResult.value == HccAllocTag
	HCC_ERROR_MESSAGES,
	HCC_ERROR_NOT_FINISHED,
	HCC_ERROR_NOT_A_DIR,
	HCC_ERROR_FILE_OPEN_READ,
	HCC_ERROR_FILE_READ,
	HCC_ERROR_OPEN_OUTPUT_FILE,

	HCC_ERROR_THREAD_INIT,
	HCC_ERROR_THREAD_WAIT_FOR_TERMINATION,
	HCC_ERROR_SEMAPHORE_GIVE,
	HCC_ERROR_SEMAPHORE_TAKE,
	HCC_ERROR_MUTEX_LOCK,
	HCC_ERROR_MUTEX_UNLOCK,

	HCC_ERROR_END,
#define HCC_ERROR_COUNT (HCC_ERROR_END - HCC_ERROR_ALLOCATION_FAILURE)
};

typedef struct HccResult HccResult;
struct HccResult {
	HccResultCode code;
	int32_t       value;
	char*         stacktrace;
};
#define HccResult(code, value, stacktrace) ((HccResult) { code, value, stacktrace })

#define HCC_RESULT_SUCCESS ((HccResult){0})
#define HCC_IS_SUCCESS(result) (result.code >= 0)
#define HCC_ENSURE(expr) { HccResult result__ = (expr); if (result__.code < 0) { hcc_result_print(#expr, result__); exit(1); } }

extern const char* hcc_success_strings[HCC_SUCCESS_COUNT];
extern const char* hcc_error_strings[HCC_ERROR_COUNT];
void hcc_result_print(char* what, HccResult result);

// ===========================================
//
//
// IO Interface
//
//
// ===========================================

typedef struct HccIIO HccIIO;
typedef uintptr_t (*HccIIOReadFn)(HccIIO* iio, void* data_out, uintptr_t size);
typedef uintptr_t (*HccIIOWriteFn)(HccIIO* iio, const void* data, uintptr_t size);
typedef uintptr_t (*HccIIOWriteFmtFn)(HccIIO* iio, const char* fmt, va_list va_args);
typedef void (*HccIIOFlushFn)(HccIIO* iio);
typedef void (*HccIIOCloseFn)(HccIIO* iio);

struct HccIIO {
	void*            handle;
	uintptr_t        cursor;
	uintptr_t        size;
	HccIIOReadFn     read_fn;
	HccIIOWriteFn    write_fn;
	HccIIOWriteFmtFn write_fmt_fn;
	HccIIOFlushFn    flush_fn;
	HccIIOCloseFn    close_fn;
	bool             ascii_colors_enabled;
};

HccIIO hcc_iio_file(FILE* f);
HccIIO hcc_iio_memory(void* data, uintptr_t size);
bool hcc_iio_get_ascii_colors_enabled(HccIIO* iio);
void hcc_iio_set_ascii_colors_enabled(HccIIO* iio, bool enabled);
uintptr_t hcc_iio_read(HccIIO* iio, void* data_out, uintptr_t size);
uintptr_t hcc_iio_write(HccIIO* iio, const void* data, uintptr_t size);
uintptr_t hcc_iio_write_fmt(HccIIO* iio, const char* fmt, ...);
#ifdef __GNUC__
uintptr_t hcc_iio_write_fmt(HccIIO* iio, const char* fmt, ...) __attribute__ ((format (printf, 2, 3)));
#else
uintptr_t hcc_iio_write_fmt(HccIIO* iio, const char* fmt, ...);
#endif
void hcc_iio_flush(HccIIO* iio);
void hcc_iio_close(HccIIO* iio);

// ===========================================
//
//
// Allocation Tagging
//
//
// ===========================================

typedef uint16_t HccAllocTag;
enum HccAllocTag {
	HCC_ALLOC_TAG_NONE,
	HCC_ALLOC_TAG_GLOBAL_MEM_ARENA,
	HCC_ALLOC_TAG_CODE,
	HCC_ALLOC_TAG_STRING_TABLE_ENTRIES,
	HCC_ALLOC_TAG_STRING_TABLE_DATA,
	HCC_ALLOC_TAG_STRING_TABLE_ID_TO_ENTRY_MAP,
	HCC_ALLOC_TAG_WORKER_CALL_STACKS,
	HCC_ALLOC_TAG_WORKER_JOB_QUEUE,
	HCC_ALLOC_TAG_ATA_TEXT,
	HCC_ALLOC_TAG_ATA_BINARY,
	HCC_ALLOC_TAG_ATA,
	HCC_ALLOC_TAG_AST_TEXT,
	HCC_ALLOC_TAG_AST_BINARY,
	HCC_ALLOC_TAG_AST,
	HCC_ALLOC_TAG_AML_TEXT,
	HCC_ALLOC_TAG_AML_BINARY,
	HCC_ALLOC_TAG_AML,
	HCC_ALLOC_TAG_WORKER_STRING_BUFFER,
	HCC_ALLOC_TAG_WORKER_ARENA,

	HCC_ALLOC_TAG_CU_SHADER_FUNCTION_DECLS,
	HCC_ALLOC_TAG_CU_RESOURCE_STRUCTS,
	HCC_ALLOC_TAG_CU_GLOBAL_DECLARATIONS,
	HCC_ALLOC_TAG_CU_STRUCT_DECLARATIONS,
	HCC_ALLOC_TAG_CU_UNION_DECLARATIONS,
	HCC_ALLOC_TAG_CU_ENUM_DECLARATIONS,

	HCC_ALLOC_TAG_DATA_TYPE_TABLE_ARRAYS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_COMPOUNDS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_COMPOUND_FIELDS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_TYPEDEFS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_ENUMS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_ENUM_VALUES,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_POINTERS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_FUNCTIONS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_FUNCTION_PARAMS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_BUFFERS,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_ARRAYS_DEDUP_HASH_TABLE,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_POINTERS_DEDUP_HASH_TABLE,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_FUNCTIONS_DEDUP_HASH_TABLE,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_BUFFERS_DEDUP_HASH_TABLE,
	HCC_ALLOC_TAG_DATA_TYPE_TABLE_ANON_COMPOUND_DEDUP_HASH_TABLE,

	HCC_ALLOC_TAG_ATA_TOKEN_BAG_TOKENS,
	HCC_ALLOC_TAG_ATA_TOKEN_BAG_LOCATIONS,
	HCC_ALLOC_TAG_ATA_TOKEN_BAG_VALUES,
	HCC_ALLOC_TAG_AST_FILE_MACROS,
	HCC_ALLOC_TAG_AST_FILE_MACRO_PARAMS,
	HCC_ALLOC_TAG_AST_FILE_PRAGMA_ONCED_FILES,
	HCC_ALLOC_TAG_AST_FILE_UNIQUE_INCLUDED_FILES,
	HCC_ALLOC_TAG_AST_FORWARD_DECLARTIONS_TO_LINK,
	HCC_ALLOC_TAG_AST_FILE_GLOBAL_DECLARATIONS,
	HCC_ALLOC_TAG_AST_FILE_STRUCT_DECLARATIONS,
	HCC_ALLOC_TAG_AST_FILE_UNION_DECLARATIONS,
	HCC_ALLOC_TAG_AST_FILE_ENUM_DECLARATIONS,
	HCC_ALLOC_TAG_AST_FILES_HASH_TABLE,
	HCC_ALLOC_TAG_AST_FILES,
	HCC_ALLOC_TAG_AST_FUNCTION_PARAMS_AND_VARIABLES,
	HCC_ALLOC_TAG_AST_FUNCTIONS,
	HCC_ALLOC_TAG_AST_EXPRS,
	HCC_ALLOC_TAG_AST_GLOBAL_VARIBALES,
	HCC_ALLOC_TAG_AST_FORWARD_DECLARTIONS,
	HCC_ALLOC_TAG_AST_DESIGNATED_INITIALIZER_ELMT_INDICES,

	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_NODES_POOL,
	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_WORDS_POOL,
	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_VALUES_POOL,
	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_BASIC_BLOCKS_POOL,
	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_BASIC_BLOCK_PARAMS_POOL,
	HCC_ALLOC_TAG_AML_FUNCTION_ALCTOR_BASIC_BLOCK_PARAM_SRCS_POOL,
	HCC_ALLOC_TAG_AML_FUNCTIONS,
	HCC_ALLOC_TAG_AML_LOCATIONS,
	HCC_ALLOC_TAG_AML_CALL_GRAPH_NODES,
	HCC_ALLOC_TAG_AML_OPIMIZE_FUNCTIONS,
	HCC_ALLOC_TAG_AML_FUNCTION_CALL_NODE_LISTS,

	HCC_ALLOC_TAG_SPIRV_FUNCTIONS,
	HCC_ALLOC_TAG_SPIRV_FUNCTION_WORDS,
	HCC_ALLOC_TAG_SPIRV_TYPE_TABLE,
	HCC_ALLOC_TAG_SPIRV_DECL_TABLE,
	HCC_ALLOC_TAG_SPIRV_DESCRIPTOR_BINDING_TABLE,
	HCC_ALLOC_TAG_SPIRV_CONSTANT_TABLE,
	HCC_ALLOC_TAG_SPIRV_TYPES_AND_CONSTANTS,
	HCC_ALLOC_TAG_SPIRV_TYPE_ELMT_IDS,
	HCC_ALLOC_TAG_SPIRV_ENTRY_POINTS,
	HCC_ALLOC_TAG_SPIRV_ENTRY_POINT_GLOBAL_VARIABLE_IDS,
	HCC_ALLOC_TAG_SPIRV_GLOBAL_VARIABLE_WORDS,
	HCC_ALLOC_TAG_SPIRV_NAME_WORDS,
	HCC_ALLOC_TAG_SPIRV_DECORATE_WORDS,

	HCC_ALLOC_TAG_PPGEN_EXPAND_STACK,
	HCC_ALLOC_TAG_PPGEN_EXPAND_MACRO_IDX_STACK,
	HCC_ALLOC_TAG_PPGEN_STRINGIFY_BUFFER,
	HCC_ALLOC_TAG_PPGEN_IF_STACK,
	HCC_ALLOC_TAG_PPGEN_MACRO_DECLARATIONS,
	HCC_ALLOC_TAG_PPGEN_MACRO_ARGS_STACK,
	HCC_ALLOC_TAG_ATAGEN_PAUSED_FILE_STACK,
	HCC_ALLOC_TAG_ATAGEN_OPEN_BRACKET_STACK,

	HCC_ALLOC_TAG_ASTGEN_VARIABLE_STACK_STRINGS,
	HCC_ALLOC_TAG_ASTGEN_VARIABLE_STACK,
	HCC_ALLOC_TAG_ASTGEN_COMPOUND_FIELD_NAMES,
	HCC_ALLOC_TAG_ASTGEN_COMPOUND_FIELD_LOCATIONS,
	HCC_ALLOC_TAG_ASTGEN_COMPOUND_TYPE_FIND_FIELDS,
	HCC_ALLOC_TAG_ASTGEN_COMPOUND_FIELDS,
	HCC_ALLOC_TAG_ASTGEN_FUNCTION_PARAMS_AND_VARIABLES,
	HCC_ALLOC_TAG_ASTGEN_ENUM_VALUES,
	HCC_ALLOC_TAG_ASTGEN_CURLY_INITIALIZER_NESTED,
	HCC_ALLOC_TAG_ASTGEN_CURLY_INITIALIZER_NESTED_CURLYS,
	HCC_ALLOC_TAG_ASTGEN_CURLY_INITIALIZER_NESTED_ELMTS,

	HCC_ALLOC_TAG_SPIRVLINK_WORDS,

	HCC_ALLOC_TAG_COUNT,
};

typedef uint8_t HccAllocMode;
enum HccAllocMode {
	HCC_ALLOC_MODE_ALLOC,
	HCC_ALLOC_MODE_DEALLOC,
};

typedef void (*HccAllocEventFn)(void* userdata, HccAllocMode mode, HccAllocTag tag, void* addr, uintptr_t size);

extern const char* hcc_alloc_tag_strings[HCC_ALLOC_TAG_COUNT];

typedef struct HccTrackedMem HccTrackedMem;
struct HccTrackedMem {
	HccAllocTag tag;
	void*       addr;
	uintptr_t   size;
};

typedef struct HccMemTrackerIter HccMemTrackerIter;

HccMemTrackerIter* hcc_mem_tracker_iter_start(void);
void hcc_mem_tracker_iter_finish(HccMemTrackerIter* iter);
bool hcc_mem_tracker_iter_next(HccMemTrackerIter* iter, HccTrackedMem* out);

void hcc_mem_tracker_log(HccIIO* iio);

// ===========================================
//
//
// String
//
//
// ===========================================

typedef struct HccString HccString;
struct HccString {
	char* data;
	uintptr_t size;
};

#define hcc_string(data, size) ((HccString) { data, size })
#define hcc_string_lit(lit) ((HccString) { lit, sizeof(lit) - 1 })
#define hcc_string_c(string) ((HccString) { string, strlen(string) })
#define hcc_string_c_path(string) ((HccString) { string, strlen(string) + 1 })

// ===========================================
//
//
// Time Utilities
//
//
// ===========================================

typedef struct HccDuration HccDuration;
struct HccDuration {
	uint64_t secs;
	uint32_t nanosecs;
};

typedef uint8_t HccTimeMode;
enum HccTimeMode {
	// will follow the realtime system time, is effected by system time changes
	// use this if you want the system time.
	HCC_TIME_MODE_REALTIME,
	// some arbitrary time that is used as a reference point and not effected by system time.
	// use this to measure a duration between two times.
	HCC_TIME_MODE_MONOTONIC,
};

typedef struct HccTime HccTime;
struct HccTime {
	uint64_t secs;
	uint32_t nanosecs;
};

HccTime hcc_time_now(HccTimeMode mode);
HccDuration hcc_time_elapsed(HccTime time, HccTimeMode mode);
HccDuration hcc_time_diff(HccTime to, HccTime from);

#define hcc_duration_init(secs_, nanosecs_) (HccDuration) { .secs = secs_, .nanosecs = nanosecs_ }
#define hcc_duration_from_millisecs(millisecs) (HccDuration) { .secs = (millisecs) / 1000, .nanosecs = ((millisecs) % 1000) * 1000000 }
#define hcc_duration_from_microsecs(microsecs) (HccDuration) { .secs = (microsecs) / 1000000, .nanosecs = ((microsecs) % 1000000) * 1000 }
#define hcc_duration_from_nanosecs(nanosecs_) (HccDuration) { .secs = (nanosecs_) / 1000000000, .nanosecs = (nanosecs_) % 1000000000 }

bool hcc_duration_has_secs(HccDuration duration);
bool hcc_duration_has_millisecs(HccDuration duration);
bool hcc_duration_has_microsecs(HccDuration duration);
bool hcc_duration_has_nanosecs(HccDuration duration);
float hcc_duration_to_f32_secs(HccDuration duration);
double hcc_duration_to_f64_secs(HccDuration duration);
float hcc_duration_to_f32_millisecs(HccDuration duration);
double hcc_duration_to_f64_millisecs(HccDuration duration);
float hcc_duration_to_f32_microsecs(HccDuration duration);
double hcc_duration_to_f64_microsecs(HccDuration duration);
uint64_t hcc_duration_secs(HccDuration duration);
uint64_t hcc_duration_millisecs(HccDuration duration);
uint64_t hcc_duration_microsecs(HccDuration duration);
uint64_t hcc_duration_nanosecs(HccDuration duration);
uint64_t hcc_duration_frame_to_fps(HccDuration duration);
HccDuration hcc_duration_add(HccDuration a, HccDuration b);
HccDuration hcc_duration_sub(HccDuration a, HccDuration b);
bool hcc_duration_lt(HccDuration a, HccDuration b);
bool hcc_duration_gt(HccDuration a, HccDuration b);

void hcc_location_merge_apply(HccLocation* before, HccLocation* after);

// ===========================================
//
//
// Message: Error & Warn
//
//
// ===========================================

typedef uint32_t HccMessageCode;

typedef uint8_t HccMessageType;
enum HccMessageType {
	HCC_MESSAGE_TYPE_ERROR = 0x1,
	HCC_MESSAGE_TYPE_WARN = 0x2,

	HCC_MESSAGE_TYPE_COUNT,
};

typedef struct HccMessage HccMessage;
struct HccMessage {
	HccString      string; // points to HccMessageSys.message_strings
	HccMessageType type;
	HccMessageCode code;
	HccLocation*   location;
	HccLocation*   other_location;
};

typedef HccMessageCode HccErrorCode;
enum {
	HCC_ERROR_CODE_NONE,

	//
	// ATAGEN
	HCC_ERROR_CODE_INVALID_TOKEN_MACRO_IDENTIFIER,
	HCC_ERROR_CODE_INVALID_TOKEN_MACRO_PARAM_IDENTIFIER,
	HCC_ERROR_CODE_DUPLICATE_MACRO_PARAM_IDENTIFIER,
	HCC_ERROR_CODE_INVALID_MACRO_PARAM_DELIMITER,
	HCC_ERROR_CODE_MACRO_PARAM_VA_ARG_NOT_LAST,
	HCC_ERROR_CODE_MACRO_ALREADY_DEFINED,
	HCC_ERROR_CODE_INVALID_INCLUDE_OPERAND,
	HCC_ERROR_CODE_TOO_MANY_INCLUDE_OPERANDS,
	HCC_ERROR_CODE_INCLUDE_PATH_IS_EMPTY,
	HCC_ERROR_CODE_INCLUDE_PATH_DOES_NOT_EXIST,
	HCC_ERROR_CODE_FAILED_TO_OPEN_FILE_FOR_READ,
	HCC_ERROR_CODE_CONDITION_HAS_NO_PP_TOKENS,
	HCC_ERROR_CODE_INVALID_PP_BINARY_OP,
	HCC_ERROR_CODE_INVALID_PP_UNARY_EXPR,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE,
	HCC_ERROR_CODE_UNDEFINED_IDENTIFIER_IN_PP_EXPR,
	HCC_ERROR_CODE_EXPECTED_COLON_FOR_TERNARY_OP,
	HCC_ERROR_CODE_INVALID_PP_LINE_OPERANDS,
	HCC_ERROR_CODE_PP_LINE_MUST_BE_MORE_THAN_ZERO,
	HCC_ERROR_CODE_TOO_MANY_PP_LINE_OPERANDS,
	HCC_ERROR_CODE_PP_ERROR,
	HCC_ERROR_CODE_INVALID_PP_PRAGMA_OPERAND,
	HCC_ERROR_CODE_PP_PRAGMA_OPERAND_USED_IN_MAIN_FILE,
	HCC_ERROR_CODE_TOO_MANY_PP_PRAGMA_OPERANDS,
	HCC_ERROR_CODE_INVALID_TOKEN_PREPROCESSOR_DIRECTIVE,
	HCC_ERROR_CODE_INVALID_PREPROCESSOR_DIRECTIVE,
	HCC_ERROR_CODE_PP_ENDIF_BEFORE_IF,
	HCC_ERROR_CODE_PP_ELSEIF_CANNOT_FOLLOW_ELSE,
	HCC_ERROR_CODE_PP_IF_UNTERMINATED,
	HCC_ERROR_CODE_INVALID_PP_CONCAT_OPERANDS,
	HCC_ERROR_CODE_TOO_MANY_UNDEF_OPERANDS,
	HCC_ERROR_CODE_TOO_MANY_IFDEF_OPERANDS,
	HCC_ERROR_CODE_PP_DIRECTIVE_NOT_FIRST_ON_LINE,
	HCC_ERROR_CODE_INVALID_OCTAL_DIGIT,
	HCC_ERROR_CODE_MAX_UINT_OVERFLOW,
	HCC_ERROR_CODE_MAX_SINT_OVERFLOW,
	HCC_ERROR_CODE_MAX_SINT_OVERFLOW_DECIMAL,
	HCC_ERROR_CODE_MAX_FLOAT_OVERFLOW,
	HCC_ERROR_CODE_U_SUFFIX_ALREADY_USED,
	HCC_ERROR_CODE_U_SUFFIX_ON_FLOAT,
	HCC_ERROR_CODE_L_SUFFIX_ON_FLOAT,
	HCC_ERROR_CODE_LONG_DOUBLE_IS_UNSUPPORTED,
	HCC_ERROR_CODE_FLOAT_HAS_DOUBLE_FULL_STOP,
	HCC_ERROR_CODE_FLOAT_MUST_BE_DECIMAL,
	HCC_ERROR_CODE_FLOAT_SUFFIX_MUST_FOLLOW_DECIMAL_PLACE,
	HCC_ERROR_CODE_INVALID_INTEGER_LITERALS,
	HCC_ERROR_CODE_INVALID_FLOAT_LITERALS,
	HCC_ERROR_CODE_NO_BRACKETS_OPEN,
	HCC_ERROR_CODE_INVALID_CLOSE_BRACKET_PAIR,
	HCC_ERROR_CODE_UNCLOSED_BRACKET,
	HCC_ERROR_CODE_UNCLOSED_STRING_LITERAL,
	HCC_ERROR_CODE_MACRO_STARTS_WITH_CONCAT,
	HCC_ERROR_CODE_STRINGIFY_MUST_BE_MACRO_PARAM,
	HCC_ERROR_CODE_INVALID_TOKEN,
	HCC_ERROR_CODE_INVALID_TOKEN_HASH_IN_PP_OPERAND,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_PP_IF_DEFINED,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_DEFINED,
	HCC_ERROR_CODE_INVALID_USE_OF_VA_ARGS,
	HCC_ERROR_CODE_VA_ARGS_IN_MACRO_PARAMETER,
	HCC_ERROR_CODE_NOT_ENOUGH_MACRO_ARGUMENTS,
	HCC_ERROR_CODE_TOO_MANY_MACRO_ARGUMENTS,

	//
	// ASTGEN
	HCC_ERROR_CODE_CANNOT_FIND_FIELD,
	HCC_ERROR_CODE_CANNOT_FIND_FIELD_VECTOR,
	HCC_ERROR_CODE_DUPLICATE_FIELD_IDENTIFIER,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_CONDITION,
	HCC_ERROR_CODE_MISSING_SEMICOLON,
	HCC_ERROR_CODE_REDEFINITION_IDENTIFIER_INTERNAL,
	HCC_ERROR_CODE_REDEFINITION_IDENTIFIER_EXTERNAL,
	HCC_ERROR_CODE_FUNCTION_PROTOTYPE_MISMATCH,
	HCC_ERROR_CODE_FUNCTION_BODY_MISMATCH,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_ENUM,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_ENUM_GOT_SEMICOLON,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_UNNAMED_ENUM,
	HCC_ERROR_CODE_REIMPLEMENTATION_DATA_TYPE,
	HCC_ERROR_CODE_EMPTY_ENUM,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_ENUM_VALUE,
	HCC_ERROR_CODE_ENUM_VALUE_OVERFLOW,
	HCC_ERROR_CODE_ENUM_VALUE_INVALID_FORMAT,
	HCC_ERROR_CODE_ENUM_VALUE_INVALID_TERMINATOR_WITH_EXPLICIT_VALUE,
	HCC_ERROR_CODE_ENUM_VALUE_INVALID_TERMINATOR,
	HCC_ERROR_CODE_INTRINSIC_NOT_FOUND_FUNCTION,
	HCC_ERROR_CODE_INTRINSIC_NOT_FOUND_STRUCT,
	HCC_ERROR_CODE_INTRINSIC_NOT_FOUND_UNION,
	HCC_ERROR_CODE_INVALID_SPECIFIER_FOR_STRUCT,
	HCC_ERROR_CODE_INVALID_SPECIFIER_CONFIG_FOR_STRUCT,
	HCC_ERROR_CODE_NOT_AVAILABLE_FOR_UNION,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_ANON_STRUCT_TYPE,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_ANON_UNION_TYPE,
	HCC_ERROR_CODE_INVALID_SPECIFIER_FOR_STRUCT_FIELD,
	HCC_ERROR_CODE_INVALID_SPECIFIER_CONFIG_FOR_STRUCT_FIELD,
	HCC_ERROR_CODE_COMPOUND_FIELD_INVALID_TERMINATOR,
	HCC_ERROR_CODE_COMPOUND_FIELD_MISSING_NAME,
	HCC_ERROR_CODE_INTRINSIC_INVALID_COMPOUND_STRUCT_FIELDS_COUNT,
	HCC_ERROR_CODE_INTRINSIC_INVALID_COMPOUND_STRUCT_FIELD,
	HCC_ERROR_CODE_INTRINSIC_VECTOR_INVALID_SIZE_AND_ALIGN,
	HCC_ERROR_CODE_MISSING_RASTERIZER_STATE_SPECIFIER,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_ALIGNAS,
	HCC_ERROR_CODE_ALIGNAS_ON_SPECIAL_COMPOUND_DATA_TYPE,
	HCC_ERROR_CODE_INVALID_ALIGNAS_INT_CONSTANT,
	HCC_ERROR_CODE_INVALID_ALIGNAS_OPERAND,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_ALIGNAS,
	HCC_ERROR_CODE_ALIGNAS_REDUCES_ALIGNMENT,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_GENERIC,
	HCC_ERROR_CODE_EXPECTED_COMMA_GENERIC,
	HCC_ERROR_CODE_EXPECTED_COMMA_OR_PARENTHESIS_CLOSE_GENERIC,
	HCC_ERROR_CODE_EXPECTED_DATA_TYPE_CASE_GENERIC,
	HCC_ERROR_CODE_EXPECTED_COLON_GENERIC,
	HCC_ERROR_CODE_EXPECTED_DUPLICATE_CASE_GENERIC,
	HCC_ERROR_CODE_NO_DATA_TYPE_CASE_GENERIC,
	HCC_ERROR_CODE_EXPECTED_NON_VOID_DATA_TYPE,
	HCC_ERROR_CODE_POSITION_MUST_BE_VEC4_F32,
	HCC_ERROR_CODE_EXPECTED_TYPE_NAME,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_VECTOR_T,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_VECTOR_T,
	HCC_ERROR_CODE_EXPECTED_BUILTIN_SCALAR_TYPE,
	HCC_ERROR_CODE_EXPECTED_COMMA_VECTOR_T,
	HCC_ERROR_CODE_EXPECTED_INTEGER_VECTOR_T,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_RESOURCE_TYPE_GENERIC,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_RESOURCE_TYPE_GENERIC,
	HCC_ERROR_CODE_EXPECTED_NO_CONST_QUALIFIERS_FOR_BUFFER_TYPE,
	HCC_ERROR_CODE_EXPECTED_NO_VOLATILE_QUALIFIERS_FOR_BUFFER_TYPE,
	HCC_ERROR_CODE_EXPECTED_NO_TYPE_QUALIFIERS_FOR_TEXTURE_TYPE,
	HCC_ERROR_CODE_EXPECTED_POD_DATA_TYPE_FOR_BUFFER,
	HCC_ERROR_CODE_INVALID_TEXEL_TYPE,
	HCC_ERROR_CODE_UNSIGNED_OR_SIGNED_ON_NON_INT_TYPE,
	HCC_ERROR_CODE_COMPLEX_ON_NON_FLOAT_TYPE,
	HCC_ERROR_CODE_MULTIPLE_TYPES_SPECIFIED,
	HCC_ERROR_CODE_COMPLEX_UNSUPPORTED_AT_THIS_TIME,
	HCC_ERROR_CODE_UNSIGNED_AND_SIGNED,
	HCC_ERROR_CODE_ATOMIC_UNSUPPORTED_AT_THIS_TIME,
	HCC_ERROR_CODE_DUPLICATE_TYPE_SPECIFIER,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_TYPEDEF,
	HCC_ERROR_CODE_INVALID_SPECIFIER_FOR_TYPEDEF,
	HCC_ERROR_CODE_INTRINSIC_NOT_FOUND_TYPEDEF,
	HCC_ERROR_CODE_INTRINSIC_INVALID_TYPEDEF,
	HCC_ERROR_CODE_TYPE_MISMATCH_IMPLICIT_CAST,
	HCC_ERROR_CODE_TYPE_MISMATCH_IMPLICIT_CAST_BUT_CAN_EXPLICITLY,
	HCC_ERROR_CODE_TYPE_MISMATCH,
	HCC_ERROR_CODE_MISSING_RETURN_EXPR,
	HCC_ERROR_CODE_UNSUPPORTED_BINARY_OPERATOR,
	HCC_ERROR_CODE_ATTEMPTING_TO_READ_FROM_MUTONLY,
	HCC_ERROR_CODE_INVALID_CURLY_EXPR,
	HCC_ERROR_CODE_FIELD_DESIGNATOR_ON_ARRAY_TYPE,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_FIELD_DESIGNATOR,
	HCC_ERROR_CODE_ARRAY_DESIGNATOR_ON_COMPOUND_TYPE,
	HCC_ERROR_CODE_EXPECTED_INTEGER_FOR_ARRAY_IDX,
	HCC_ERROR_CODE_ARRAY_INDEX_OUT_OF_BOUNDS,
	HCC_ERROR_CODE_ARRAY_DESIGNATOR_EXPECTED_SQUARE_BRACE_CLOSE,
	HCC_ERROR_CODE_EXPECTED_ASSIGN_OR_ARRAY_DESIGNATOR,
	HCC_ERROR_CODE_EXPECTED_ASSIGN_OR_FIELD_DESIGNATOR,
	HCC_ERROR_CODE_EXPECTED_ASSIGN,
	HCC_ERROR_CODE_UNARY_OPERATOR_NOT_SUPPORTED,
	HCC_ERROR_CODE_ADDRESS_OF_NOT_SUPPORT_ON_BITFIELD,
	HCC_ERROR_CODE_UNDECLARED_IDENTIFIER,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_EXPR,
	HCC_ERROR_CODE_INVALID_CAST,
	HCC_ERROR_CODE_INVALID_CURLY_INITIALIZER_LIST_END,
	HCC_ERROR_CODE_SIZEALIGNOF_TYPE_OPERAND_NOT_WRAPPED,
	HCC_ERROR_CODE_EXPECTED_EXPR,
	HCC_ERROR_CODE_NOT_ENOUGH_FUNCTION_ARGS,
	HCC_ERROR_CODE_TOO_MANY_FUNCTION_ARGS,
	HCC_ERROR_CODE_INVALID_FUNCTION_ARG_DELIMITER,
	HCC_ERROR_CODE_ARRAY_SUBSCRIPT_EXPECTED_SQUARE_BRACE_CLOSE,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_FIELD_ACCESS,
	HCC_ERROR_CODE_MISSING_COLON_TERNARY_OP,
	HCC_ERROR_CODE_PARENTHISES_USED_ON_NON_FUNCTION,
	HCC_ERROR_CODE_SQUARE_BRACE_USED_ON_NON_ARRAY_DATA_TYPE,
	HCC_ERROR_CODE_FULL_STOP_USED_ON_NON_COMPOUND_DATA_TYPE,
	HCC_ERROR_CODE_ARROW_RIGHT_USED_ON_NON_COMPOUND_DATA_TYPE_POINTER,
	HCC_ERROR_CODE_COMPOUND_DATA_TYPE_IS_EMPTY,
	HCC_ERROR_CODE_CANNOT_ASSIGN_TO_CONST,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_CONDITION_EXPR,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_CONDITION_EXPR,
	HCC_ERROR_CODE_EXPECTED_ARRAY_SIZE,
	HCC_ERROR_CODE_EXPECTED_INTEGER_CONSTANT_ARRAY_SIZE,
	HCC_ERROR_CODE_ARRAY_SIZE_CANNOT_BE_NEGATIVE,
	HCC_ERROR_CODE_ARRAY_SIZE_CANNOT_BE_ZERO,
	HCC_ERROR_CODE_ARRAY_DECL_EXPECTED_SQUARE_BRACE_CLOSE,
	HCC_ERROR_CODE_UNSUPPORTED_SPECIFIER,
	HCC_ERROR_CODE_UNSUPPORTED_TEXTURE_ELEMENT_TYPE,
	HCC_ERROR_CODE_SPECIFIER_ALREADY_BEEN_USED,
	HCC_ERROR_CODE_UNUSED_SPECIFIER,
	HCC_ERROR_CODE_INVALID_SPECIFIER_VARIABLE_DECL,
	HCC_ERROR_CODE_INVALID_SPECIFIER_FUNCTION_DECL,
	HCC_ERROR_CODE_REDEFINITION_IDENTIFIER_LOCAL,
	HCC_ERROR_CODE_STATIC_VARIABLE_INITIALIZER_MUST_BE_CONSTANT,
	HCC_ERROR_CODE_INVALID_VARIABLE_DECL_TERMINATOR,
	HCC_ERROR_CODE_INVALID_ELSE,
	HCC_ERROR_CODE_INVALID_SWITCH_CONDITION_TYPE,
	HCC_ERROR_CODE_EXPECTED_CURLY_OPEN_SWITCH_STATEMENT,
	HCC_ERROR_CODE_EXPECTED_WHILE_CONDITION_FOR_DO_WHILE,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_FOR,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_FOR_VARIABLE_DECL,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_FOR,
	HCC_ERROR_CODE_CASE_STATEMENT_OUTSIDE_OF_SWITCH,
	HCC_ERROR_CODE_SWITCH_CASE_VALUE_MUST_BE_A_CONSTANT,
	HCC_ERROR_CODE_EXPECTED_COLON_SWITCH_CASE,
	HCC_ERROR_CODE_DEFAULT_STATMENT_OUTSIDE_OF_SWITCH,
	HCC_ERROR_CODE_DEFAULT_STATEMENT_ALREADY_DECLARED,
	HCC_ERROR_CODE_EXPECTED_COLON_SWITCH_DEFAULT,
	HCC_ERROR_CODE_INVALID_BREAK_STATEMENT_USAGE,
	HCC_ERROR_CODE_INVALID_CONTINUE_STATEMENT_USAGE,
	HCC_ERROR_CODE_MULTIPLE_SHADER_STAGES_ON_FUNCTION,
	HCC_ERROR_CODE_VERTEX_SHADER_MUST_RETURN_RASTERIZER_STATE,
	HCC_ERROR_CODE_PIXEL_SHADER_MUST_RETURN_PIXEL_STATE,
	HCC_ERROR_CODE_EXPECTED_IDENTIFIER_FUNCTION_PARAM,
	HCC_ERROR_CODE_REDEFINITION_IDENTIFIER_FUNCTION_PARAM,
	HCC_ERROR_CODE_SHADER_PROTOTYPE_INVALID_VERTEX,
	HCC_ERROR_CODE_SHADER_PROTOTYPE_INVALID_PIXEL,
	HCC_ERROR_CODE_SHADER_PROTOTYPE_INVALID_COMPUTE,
	HCC_ERROR_CODE_FUNCTION_INVALID_TERMINATOR,
	HCC_ERROR_CODE_CANNOT_CALL_SHADER_FUNCTION,
	HCC_ERROR_CODE_CANNOT_CALL_UNIMPLEMENTED_FUNCTION,
	HCC_ERROR_CODE_UNEXPECTED_TOKEN_FUNCTION_PROTOTYPE_END,
	HCC_ERROR_CODE_UNEXPECTED_TOKEN,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_RASTERIZER_STATE,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_PIXEL_STATE,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_COMPOUND_DATA_TYPE,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_FUNCTION_PARAM,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_FUNCTION_PARAM_INLINE,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_VARIABLE,
	HCC_ERROR_CODE_INVALID_DATA_TYPE_FOR_POINTER_DATA_TYPE,
	HCC_ERROR_CODE_RASTERIZER_STATE_RESOURCE_MUST_BE_NOINTERP,
	HCC_ERROR_CODE_ONLY_SINGLE_POINTERS_ARE_SUPPORTED,
	HCC_ERROR_CODE_POINTERS_NOT_SUPPORTED,
	HCC_ERROR_CODE_LOGICAL_ADDRESSED_VAR_USED_BEFORE_ASSIGNED,
	HCC_ERROR_CODE_LOGICAL_ADDRESSED_CONDITIONALLY_ASSIGNED_BEFORE_USE,
	HCC_ERROR_CODE_NON_CONST_STATIC_VARIABLE_CANNOT_BE_LOGICALLY_ADDRESSED,
	HCC_ERROR_CODE_INCOMPLETE_TYPE_USED_BY_VALUE,
	HCC_ERROR_CODE_STATIC_AND_EXTERN,
	HCC_ERROR_CODE_THREAD_LOCAL_MUST_BE_GLOBAL,
	HCC_ERROR_CODE_DISPATCH_GROUP_MUST_BE_GLOBAL,
	HCC_ERROR_CODE_DISPATCH_GROUP_CANNOT_HAVE_INITIALIZER,
	HCC_ERROR_CODE_STATIC_UNSUPPORTED_ON_SPIRV,
	HCC_ERROR_CODE_NOT_ALL_PATHS_RETURN_A_VALUE,
	HCC_ERROR_CODE_BUNDLED_CONSTANTS_MAX_SIZE_EXCEEDED,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_COMPUTE,
	HCC_ERROR_CODE_EXPECTED_NON_ZERO_UINT_COMPUTE,
	HCC_ERROR_CODE_EXPECTED_COMMA_COMPUTE,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_COMPUTE,
	HCC_ERROR_CODE_UNSIZED_ARRAY_REQUIRES_AN_INITIALIZATION,
	HCC_ERROR_CODE_STATIC_ASSERT_COND_MUST_BE_INTEGER_CONSTANT,
	HCC_ERROR_CODE_STATIC_ASSERT_COND_NOT_COMPILE_TIME_CONSTANT,
	HCC_ERROR_CODE_STATIC_ASSERT_EVALUATED_FALSE,
	HCC_ERROR_CODE_STATIC_ASSERT_EVALUATED_FALSE_MSG,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_OPEN_STATIC_ASSERT,
	HCC_ERROR_CODE_EXPECTED_PARENTHESIS_CLOSE_STATIC_ASSERT,
	HCC_ERROR_CODE_EXPECTED_STRING_MESSAGE_FOR_STATIC_ASSERT,
	HCC_ERROR_CODE_BITFIELD_IS_FOR_INTEGER_DATA_TYPES_ONLY,
	HCC_ERROR_CODE_BITFIELD_ALIGNAS_NOT_SUPPORTED,
	HCC_ERROR_CODE_EXPECTED_INTEGER_CONSTANT_BITFIELD,
	HCC_ERROR_CODE_BITFIELD_EXCEEDS_MAX_BITS_FOR_DATA_TYPE,
	HCC_ERROR_CODE_BITFIELD_IS_NOT_SUPPORTED_RASTERIZER_PIXEL_STATE,
	HCC_ERROR_CODE_UNORDERED_SWIZZLING_IS_NOT_ENABLED,
	HCC_ERROR_CODE_TOO_MANY_SWIZZLE_COMPONENTS,
	HCC_ERROR_CODE_CANNOT_ASSIGN_TO_SWIZZLE_WITH_REPEATED_COMPONENTS,

	//
	// ASTLINK
	HCC_ERROR_CODE_LINK_FUNCTION_PROTOTYPE_MISMATCH,
	HCC_ERROR_CODE_LINK_GLOBAL_VARIABLE_MISMATCH,
	HCC_ERROR_CODE_LINK_DECLARATION_UNDEFINED,

	//
	// AMLGEN
	HCC_ERROR_CODE_BUILT_IN_WRITE_ONLY_POINTER_CANNOT_BE_READ,

	//
	// AMLOPT
	HCC_ERROR_CODE_FUNCTION_RECURSION,
	HCC_ERROR_CODE_UNSUPPORTED_INTRINSIC_TYPE_USED,
	HCC_ERROR_CODE_UNION_ONLY_ALLOW_WITH_PHYSICAL_POINTERS,
	HCC_ERROR_CODE_SAMPLE_TEXTURE_WITH_IMPLICIT_MIP_OUTSIDE_OF_PIXEL_SHADER,
	HCC_ERROR_CODE_FUNCTION_CANNOT_BE_USED_OUTSIDE_OF_A_PIXEL_SHADER,
	HCC_ERROR_CODE_HLSL_PACKING_NO_STRUCT,
	HCC_ERROR_CODE_HLSL_PACKING_NO_UNION,
	HCC_ERROR_CODE_HLSL_PACKING_NO_ARRAY,
	HCC_ERROR_CODE_HLSL_PACKING_SIZE_UNDER_4_BYTE,
	HCC_ERROR_CODE_HLSL_PACKING_IMPLICIT_PADDING,
	HCC_ERROR_CODE_HLSL_PACKING_OVERFLOW_16_BYTE_BOUNDARY,
	HCC_ERROR_CODE_DISPATCH_GROUP_ONLY_FOR_COMPUTE,

	HCC_ERROR_CODE_COUNT,
};

typedef HccMessageCode HccWarnCode;
enum {
	HCC_WARN_CODE_NONE,

	//
	// ATAGEN
	HCC_WARN_CODE_PP_WARNING,

	//
	// ASTGEN
	HCC_WARN_CODE_CURLY_INITIALIZER_ON_SCALAR,
	HCC_WARN_CODE_UNUSED_INITIALIZER_REACHED_END,
	HCC_WARN_CODE_NO_DESIGNATOR_AFTER_DESIGNATOR,

	HCC_WARN_CODE_COUNT,
};

void hcc_message_print(HccIIO* iio, HccMessage* message);

void hcc_message_pushv(HccTask* t, HccMessageType type, HccMessageCode code, HccLocation* location, HccLocation* other_location, va_list va_args);
void hcc_message_push(HccTask* t, HccMessageType type, HccMessageCode code, HccLocation* location, HccLocation* other_location, ...);
void hcc_error_pushv(HccTask* t, HccErrorCode error_code, HccLocation* location, HccLocation* other_location, va_list va_args);
void hcc_error_push(HccTask* t, HccErrorCode error_code, HccLocation* location, HccLocation* other_location, ...);
void hcc_warn_pushv(HccTask* t, HccWarnCode warn_code, HccLocation* location, HccLocation* other_location, va_list va_args);
void hcc_warn_push(HccTask* t, HccWarnCode warn_code, HccLocation* location, HccLocation* other_location, ...);

// ===========================================
//
//
// AML Intrinsic Type
//
//
// ===========================================

typedef uint8_t HccAMLIntrinsicDataType;
enum HccAMLIntrinsicDataType {
	HCC_AML_INTRINSIC_DATA_TYPE_VOID = 0x0,
	HCC_AML_INTRINSIC_DATA_TYPE_BOOL = 0x1,
	HCC_AML_INTRINSIC_DATA_TYPE_S8 =   0x2,
	HCC_AML_INTRINSIC_DATA_TYPE_S16 =  0x3,
	HCC_AML_INTRINSIC_DATA_TYPE_S32 =  0x4,
	HCC_AML_INTRINSIC_DATA_TYPE_S64 =  0x5,
	HCC_AML_INTRINSIC_DATA_TYPE_U8 =   0x6,
	HCC_AML_INTRINSIC_DATA_TYPE_U16 =  0x7,
	HCC_AML_INTRINSIC_DATA_TYPE_U32 =  0x8,
	HCC_AML_INTRINSIC_DATA_TYPE_U64 =  0x9,
	HCC_AML_INTRINSIC_DATA_TYPE_F16 =  0xa,
	HCC_AML_INTRINSIC_DATA_TYPE_F32 =  0xb,
	HCC_AML_INTRINSIC_DATA_TYPE_F64 =  0xc,

	HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_COUNT = 13,

	HCC_AML_INTRINSIC_DATA_TYPE_S8X2 =    0x12,
	HCC_AML_INTRINSIC_DATA_TYPE_S16X2 =   0x13,
	HCC_AML_INTRINSIC_DATA_TYPE_S32X2 =   0x14,
	HCC_AML_INTRINSIC_DATA_TYPE_S64X2 =   0x15,
	HCC_AML_INTRINSIC_DATA_TYPE_U8X2 =    0x16,
	HCC_AML_INTRINSIC_DATA_TYPE_U16X2 =   0x17,
	HCC_AML_INTRINSIC_DATA_TYPE_U32X2 =   0x18,
	HCC_AML_INTRINSIC_DATA_TYPE_U64X2 =   0x19,
	HCC_AML_INTRINSIC_DATA_TYPE_F16X2 =   0x1a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X2 =   0x1b,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X2 =   0x1c,

	HCC_AML_INTRINSIC_DATA_TYPE_S8X3 =    0x22,
	HCC_AML_INTRINSIC_DATA_TYPE_S16X3 =   0x23,
	HCC_AML_INTRINSIC_DATA_TYPE_S32X3 =   0x24,
	HCC_AML_INTRINSIC_DATA_TYPE_S64X3 =   0x25,
	HCC_AML_INTRINSIC_DATA_TYPE_U8X3 =    0x26,
	HCC_AML_INTRINSIC_DATA_TYPE_U16X3 =   0x27,
	HCC_AML_INTRINSIC_DATA_TYPE_U32X3 =   0x28,
	HCC_AML_INTRINSIC_DATA_TYPE_U64X3 =   0x29,
	HCC_AML_INTRINSIC_DATA_TYPE_F16X3 =   0x2a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X3 =   0x2b,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X3 =   0x2c,

	HCC_AML_INTRINSIC_DATA_TYPE_S8X4 =    0x32,
	HCC_AML_INTRINSIC_DATA_TYPE_S16X4 =   0x33,
	HCC_AML_INTRINSIC_DATA_TYPE_S32X4 =   0x34,
	HCC_AML_INTRINSIC_DATA_TYPE_S64X4 =   0x35,
	HCC_AML_INTRINSIC_DATA_TYPE_U8X4 =    0x36,
	HCC_AML_INTRINSIC_DATA_TYPE_U16X4 =   0x37,
	HCC_AML_INTRINSIC_DATA_TYPE_U32X4 =   0x38,
	HCC_AML_INTRINSIC_DATA_TYPE_U64X4 =   0x39,
	HCC_AML_INTRINSIC_DATA_TYPE_F16X4 =   0x3a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X4 =   0x3b,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X4 =   0x3c,

	HCC_AML_INTRINSIC_DATA_TYPE_F16X2X2 = 0x5a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X2X3 = 0x9b,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X2X4 = 0xdc,

	HCC_AML_INTRINSIC_DATA_TYPE_F16X3X2 = 0x6a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X3X3 = 0xab,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X3X4 = 0xec,

	HCC_AML_INTRINSIC_DATA_TYPE_F16X4X2 = 0x7a,
	HCC_AML_INTRINSIC_DATA_TYPE_F32X4X3 = 0xbb,
	HCC_AML_INTRINSIC_DATA_TYPE_F64X4X4 = 0xfc,

	HCC_AML_INTRINSIC_DATA_TYPE_COUNT = 256,
};

//
// format constants
#define HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_MASK   0x0f
#define HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_MASK  0x30
#define HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_SHIFT 4
#define HCC_AML_INTRINSIC_DATA_TYPE_ROWS_MASK     0xc0
#define HCC_AML_INTRINSIC_DATA_TYPE_ROWS_SHIFT    6

//
// initializer
#define HCC_AML_INTRINSIC_DATA_TYPE(type, columns, rows) \
( \
	(type) | \
	(((columns - 1) << HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_SHIFT) & HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_MASK) | \
	((((rows) - 1) << HCC_AML_INTRINSIC_DATA_TYPE_ROWS_SHIFT) & HCC_AML_INTRINSIC_DATA_TYPE_ROWS_MASK) \
)

//
// extraction utilities
#define HCC_AML_INTRINSIC_DATA_TYPE_IS_SCALAR(type)  ((type) < HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_COUNT)
#define HCC_AML_INTRINSIC_DATA_TYPE_IS_VECTOR(type)  (HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS(type) > 1 && HCC_AML_INTRINSIC_DATA_TYPE_ROWS(type) == 1)
#define HCC_AML_INTRINSIC_DATA_TYPE_IS_MATRIX(type)  (HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS(type) > 1 && HCC_AML_INTRINSIC_DATA_TYPE_ROWS(type) > 1)
#define HCC_AML_INTRINSIC_DATA_TYPE_IS_UINT(type)  (HCC_AML_INTRINSIC_DATA_TYPE_U8 <= (type) && (type) <= HCC_AML_INTRINSIC_DATA_TYPE_U64)
#define HCC_AML_INTRINSIC_DATA_TYPE_IS_SINT(type)  (HCC_AML_INTRINSIC_DATA_TYPE_S8 <= (type) && (type) <= HCC_AML_INTRINSIC_DATA_TYPE_S64)
#define HCC_AML_INTRINSIC_DATA_TYPE_SCALAR(type)  ((type) & HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_MASK)
#define HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS(type) ((((type) & HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_MASK) >> HCC_AML_INTRINSIC_DATA_TYPE_COLUMNS_SHIFT) + 1)
#define HCC_AML_INTRINSIC_DATA_TYPE_ROWS(type)    ((((type) & HCC_AML_INTRINSIC_DATA_TYPE_ROWS_MASK) >> HCC_AML_INTRINSIC_DATA_TYPE_ROWS_SHIFT) + 1)

extern const char* hcc_aml_intrinsic_data_type_scalar_strings[HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_COUNT];
extern uint8_t hcc_aml_intrinsic_data_type_scalar_size_aligns[HCC_AML_INTRINSIC_DATA_TYPE_SCALAR_COUNT];

// ===========================================
//
//
// Intrinsic Declarations
//
//
// ===========================================

typedef uint16_t HccAMLOp;

enum {
	HCC_COMPOUND_DATA_TYPE_IDX_HCC_VERTEX_SV,
	HCC_COMPOUND_DATA_TYPE_IDX_HCC_VERTEX_SV_OUT,
	HCC_COMPOUND_DATA_TYPE_IDX_HCC_PIXEL_SV,
	HCC_COMPOUND_DATA_TYPE_IDX_HCC_PIXEL_SV_OUT,
	HCC_COMPOUND_DATA_TYPE_IDX_HCC_COMPUTE_SV,

#define HCC_COMPOUND_DATA_TYPE_IDX_STRINGS_COUNT HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_START

	HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_START,
#define HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_END (HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_START + (HCC_AML_INTRINSIC_DATA_TYPE_COUNT))

	HCC_COMPOUND_DATA_TYPE_IDX_USER_START = HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_END,
#define HCC_COMPOUND_DATA_TYPE_IDX_INTRINSICS_COUNT HCC_COMPOUND_DATA_TYPE_IDX_USER_START
};

typedef uint8_t HccManyTypeClass;
enum HccManyTypeClass {
	HCC_MANY_TYPE_CLASS_BOOL = 0x1,
	HCC_MANY_TYPE_CLASS_UINT = 0x2,
	HCC_MANY_TYPE_CLASS_SINT = 0x4,
	HCC_MANY_TYPE_CLASS_FLOAT = 0x8,
	HCC_MANY_TYPE_CLASS_TEXTURE = 0x10,
	HCC_MANY_TYPE_CLASS_BYTE_BUFFER = 0x20,

	HCC_MANY_TYPE_CLASS_SCALARS = HCC_MANY_TYPE_CLASS_BOOL | HCC_MANY_TYPE_CLASS_UINT | HCC_MANY_TYPE_CLASS_SINT | HCC_MANY_TYPE_CLASS_FLOAT,
	HCC_MANY_TYPE_CLASS_NUMBERS = HCC_MANY_TYPE_CLASS_UINT | HCC_MANY_TYPE_CLASS_SINT | HCC_MANY_TYPE_CLASS_FLOAT,
	HCC_MANY_TYPE_CLASS_INTS = HCC_MANY_TYPE_CLASS_UINT | HCC_MANY_TYPE_CLASS_SINT,
	HCC_MANY_TYPE_CLASS_SIGNED_NUMBERS = HCC_MANY_TYPE_CLASS_SINT | HCC_MANY_TYPE_CLASS_FLOAT,

	HCC_MANY_TYPE_CLASS_OPS_SCALAR = 0x40,
	HCC_MANY_TYPE_CLASS_OPS_VECTOR = 0x80,
	HCC_MANY_TYPE_CLASS_OPS_SCALAR_VECTOR = HCC_MANY_TYPE_CLASS_OPS_SCALAR | HCC_MANY_TYPE_CLASS_OPS_VECTOR,
	HCC_MANY_TYPE_CLASS_OPS_SCALAR_VECTOR_MATRIX = HCC_MANY_TYPE_CLASS_OPS_SCALAR | HCC_MANY_TYPE_CLASS_OPS_VECTOR,
	HCC_MANY_TYPE_CLASS_ALL_OPS = HCC_MANY_TYPE_CLASS_OPS_SCALAR | HCC_MANY_TYPE_CLASS_OPS_VECTOR,
};

enum {
	HCC_FUNCTION_MANY_ANY,
	HCC_FUNCTION_MANY_ALL,
	HCC_FUNCTION_MANY_ADD,
	HCC_FUNCTION_MANY_SUB,
	HCC_FUNCTION_MANY_MUL,
	HCC_FUNCTION_MANY_DIV,
	HCC_FUNCTION_MANY_MOD,
	HCC_FUNCTION_MANY_EQ,
	HCC_FUNCTION_MANY_NEQ,
	HCC_FUNCTION_MANY_LT,
	HCC_FUNCTION_MANY_LTEQ,
	HCC_FUNCTION_MANY_GT,
	HCC_FUNCTION_MANY_GTEQ,
	HCC_FUNCTION_MANY_NOT,
	HCC_FUNCTION_MANY_NEG,
	HCC_FUNCTION_MANY_BITNOT,
	HCC_FUNCTION_MANY_MIN,
	HCC_FUNCTION_MANY_MAX,
	HCC_FUNCTION_MANY_CLAMP,
	HCC_FUNCTION_MANY_SIGN,
	HCC_FUNCTION_MANY_ABS,
	HCC_FUNCTION_MANY_BITAND,
	HCC_FUNCTION_MANY_BITOR,
	HCC_FUNCTION_MANY_BITXOR,
	HCC_FUNCTION_MANY_BITSHL,
	HCC_FUNCTION_MANY_BITSHR,
	HCC_FUNCTION_MANY_BITLSB,
	HCC_FUNCTION_MANY_BITMSB,
	HCC_FUNCTION_MANY_BITCOUNT,
	HCC_FUNCTION_MANY_FMA,
	HCC_FUNCTION_MANY_FLOOR,
	HCC_FUNCTION_MANY_CEIL,
	HCC_FUNCTION_MANY_ROUND,
	HCC_FUNCTION_MANY_TRUNC,
	HCC_FUNCTION_MANY_FRACT,
	HCC_FUNCTION_MANY_RADIANS,
	HCC_FUNCTION_MANY_DEGREES,
	HCC_FUNCTION_MANY_STEP,
	HCC_FUNCTION_MANY_SMOOTHSTEP,
	HCC_FUNCTION_MANY_BITSTO,
	HCC_FUNCTION_MANY_BITSFROM,
	HCC_FUNCTION_MANY_SIN,
	HCC_FUNCTION_MANY_COS,
	HCC_FUNCTION_MANY_TAN,
	HCC_FUNCTION_MANY_ASIN,
	HCC_FUNCTION_MANY_ACOS,
	HCC_FUNCTION_MANY_ATAN,
	HCC_FUNCTION_MANY_SINH,
	HCC_FUNCTION_MANY_COSH,
	HCC_FUNCTION_MANY_TANH,
	HCC_FUNCTION_MANY_ASINH,
	HCC_FUNCTION_MANY_ACOSH,
	HCC_FUNCTION_MANY_ATANH,
	HCC_FUNCTION_MANY_ATAN2,
	HCC_FUNCTION_MANY_POW,
	HCC_FUNCTION_MANY_EXP,
	HCC_FUNCTION_MANY_LOG,
	HCC_FUNCTION_MANY_EXP2,
	HCC_FUNCTION_MANY_LOG2,
	HCC_FUNCTION_MANY_SQRT,
	HCC_FUNCTION_MANY_RSQRT,
	HCC_FUNCTION_MANY_ISINF,
	HCC_FUNCTION_MANY_ISNAN,
	HCC_FUNCTION_MANY_LERP,
	HCC_FUNCTION_MANY_CROSS,
	HCC_FUNCTION_MANY_DOT,
	HCC_FUNCTION_MANY_LEN,
	HCC_FUNCTION_MANY_NORM,
	HCC_FUNCTION_MANY_REFLECT,
	HCC_FUNCTION_MANY_REFRACT,

	HCC_FUNCTION_MANY_DDX,
	HCC_FUNCTION_MANY_DDY,
	HCC_FUNCTION_MANY_FWIDTH,
	HCC_FUNCTION_MANY_DDX_FINE,
	HCC_FUNCTION_MANY_DDY_FINE,
	HCC_FUNCTION_MANY_FWIDTH_FINE,
	HCC_FUNCTION_MANY_DDX_COARSE,
	HCC_FUNCTION_MANY_DDY_COARSE,
	HCC_FUNCTION_MANY_FWIDTH_COARSE,

	HCC_FUNCTION_MANY_QUAD_SWAP_X,
	HCC_FUNCTION_MANY_QUAD_SWAP_Y,
	HCC_FUNCTION_MANY_QUAD_SWAP_DIAGONAL,
	HCC_FUNCTION_MANY_QUAD_READ_THREAD,
	HCC_FUNCTION_MANY_QUAD_ANY,
	HCC_FUNCTION_MANY_QUAD_ALL,

	HCC_FUNCTION_MANY_WAVE_ACTIVE_ANY,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_ALL,
	HCC_FUNCTION_MANY_WAVE_READ_THREAD,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_ALL_EQUAL,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_MIN,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_MAX,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_SUM,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_PREFIX_SUM,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_PRODUCT,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_PREFIX_PRODUCT,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_COUNT_BITS,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_PREFIX_COUNT_BITS,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_BIT_AND,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_BIT_OR,
	HCC_FUNCTION_MANY_WAVE_ACTIVE_BIT_XOR,

	HCC_FUNCTION_MANY_ATOMIC_LOAD,
	HCC_FUNCTION_MANY_ATOMIC_STORE,
	HCC_FUNCTION_MANY_ATOMIC_EXCHANGE,
	HCC_FUNCTION_MANY_ATOMIC_COMPARE_EXCHANGE,
	HCC_FUNCTION_MANY_ATOMIC_ADD,
	HCC_FUNCTION_MANY_ATOMIC_SUB,
	HCC_FUNCTION_MANY_ATOMIC_MIN,
	HCC_FUNCTION_MANY_ATOMIC_MAX,
	HCC_FUNCTION_MANY_ATOMIC_BIT_AND,
	HCC_FUNCTION_MANY_ATOMIC_BIT_OR,
	HCC_FUNCTION_MANY_ATOMIC_BIT_XOR,

	HCC_FUNCTION_MANY_LOAD_TEXTURE,
	HCC_FUNCTION_MANY_FETCH_TEXTURE,
	HCC_FUNCTION_MANY_SAMPLE_TEXTURE,
	HCC_FUNCTION_MANY_SAMPLE_MIP_BIAS_TEXTURE,
	HCC_FUNCTION_MANY_SAMPLE_MIP_GRADIENT_TEXTURE,
	HCC_FUNCTION_MANY_SAMPLE_MIP_LEVEL_TEXTURE,
	HCC_FUNCTION_MANY_GATHER_RED_TEXTURE,
	HCC_FUNCTION_MANY_GATHER_GREEN_TEXTURE,
	HCC_FUNCTION_MANY_GATHER_BLUE_TEXTURE,
	HCC_FUNCTION_MANY_GATHER_ALPHA_TEXTURE,
	HCC_FUNCTION_MANY_STORE_TEXTURE,
	HCC_FUNCTION_MANY_ADDR_RO_TEXTURE,
	HCC_FUNCTION_MANY_ADDR_RW_TEXTURE,

	HCC_FUNCTION_MANY_LOAD_BYTE_BUFFER,
	HCC_FUNCTION_MANY_STORE_BYTE_BUFFER,

	HCC_FUNCTION_MANY_COUNT,
};

enum {
	HCC_FUNCTION_IDX_F16TOF32,
	HCC_FUNCTION_IDX_F16TOF64,
	HCC_FUNCTION_IDX_F32TOF16,
	HCC_FUNCTION_IDX_F64TOF16,

	HCC_FUNCTION_IDX_PACK_F16X2_F32X2,
	HCC_FUNCTION_IDX_UNPACK_F16X2_F32X2,
	HCC_FUNCTION_IDX_PACK_U16X2_F32X2,
	HCC_FUNCTION_IDX_UNPACK_U16X2_F32X2,
	HCC_FUNCTION_IDX_PACK_S16X2_F32X2,
	HCC_FUNCTION_IDX_UNPACK_S16X2_F32X2,
	HCC_FUNCTION_IDX_PACK_U8X4_F32X4,
	HCC_FUNCTION_IDX_UNPACK_U8X4_F32X4,
	HCC_FUNCTION_IDX_PACK_S8X4_F32X4,
	HCC_FUNCTION_IDX_UNPACK_S8X4_F32X4,

	HCC_FUNCTION_IDX_DISCARD_PIXEL,
	HCC_FUNCTION_IDX_MEMORY_BARRIER_RESOURCE,
	HCC_FUNCTION_IDX_MEMORY_BARRIER_DISPATCH_GROUP,
	HCC_FUNCTION_IDX_MEMORY_BARRIER_ALL,
	HCC_FUNCTION_IDX_CONTROL_BARRIER_RESOURCE,
	HCC_FUNCTION_IDX_CONTROL_BARRIER_DISPATCH_GROUP,
	HCC_FUNCTION_IDX_CONTROL_BARRIER_ALL,
	HCC_FUNCTION_IDX_WAVE_IS_FIRST_LANE,
	HCC_FUNCTION_IDX_WAVE_THREAD_IDX,

	HCC_FUNCTION_IDX_HPRINT_STRING,

#define HCC_FUNCTION_IDX_STRINGS_COUNT HCC_FUNCTION_IDX_MANY_START

	HCC_FUNCTION_IDX_MANY_START,
#define HCC_FUNCTION_IDX_MANY_END (HCC_FUNCTION_IDX_MANY_START + HCC_FUNCTION_MANY_COUNT * HCC_AML_INTRINSIC_DATA_TYPE_COUNT)

	HCC_FUNCTION_IDX_USER_START = HCC_FUNCTION_IDX_MANY_END,
#define HCC_FUNCTION_IDX_INTRINSICS_COUNT HCC_FUNCTION_IDX_USER_START
};

extern const char* hcc_intrinisic_compound_data_type_strings[HCC_COMPOUND_DATA_TYPE_IDX_STRINGS_COUNT];
extern const char* hcc_intrinisic_function_strings[HCC_FUNCTION_IDX_STRINGS_COUNT];
extern const char* hcc_intrinisic_function_many_strings[HCC_FUNCTION_MANY_COUNT];
extern HccManyTypeClass hcc_intrinisic_function_many_support[HCC_FUNCTION_MANY_COUNT];
extern HccAMLOp hcc_intrinisic_function_many_aml_ops[HCC_FUNCTION_MANY_COUNT];

// ===========================================
//
//
// AST Expressions
//
//
// ===========================================

typedef uint8_t HccASTBinaryOp;
enum HccASTBinaryOp {
	HCC_AST_BINARY_OP_ASSIGN,
	HCC_AST_BINARY_OP_ADD,
	HCC_AST_BINARY_OP_SUBTRACT,
	HCC_AST_BINARY_OP_MULTIPLY,
	HCC_AST_BINARY_OP_DIVIDE,
	HCC_AST_BINARY_OP_MODULO,
	HCC_AST_BINARY_OP_BIT_AND,
	HCC_AST_BINARY_OP_BIT_OR,
	HCC_AST_BINARY_OP_BIT_XOR,
	HCC_AST_BINARY_OP_BIT_SHIFT_LEFT,
	HCC_AST_BINARY_OP_BIT_SHIFT_RIGHT,

	//
	// logical operators (return a bool)
	HCC_AST_BINARY_OP_EQUAL,
	HCC_AST_BINARY_OP_NOT_EQUAL,
	HCC_AST_BINARY_OP_LESS_THAN,
	HCC_AST_BINARY_OP_LESS_THAN_OR_EQUAL,
	HCC_AST_BINARY_OP_GREATER_THAN,
	HCC_AST_BINARY_OP_GREATER_THAN_OR_EQUAL,

#define HCC_AST_BINARY_OP_LANG_FEATURES_START HCC_AST_BINARY_OP_LOGICAL_AND

	HCC_AST_BINARY_OP_LOGICAL_AND,
	HCC_AST_BINARY_OP_LOGICAL_OR,
	HCC_AST_BINARY_OP_TERNARY,
	HCC_AST_BINARY_OP_TERNARY_RESULTS,
	HCC_AST_BINARY_OP_COMMA,
	HCC_AST_BINARY_OP_FIELD_ACCESS,
	HCC_AST_BINARY_OP_FIELD_ACCESS_INDIRECT,
	HCC_AST_BINARY_OP_ARRAY_SUBSCRIPT,
	HCC_AST_BINARY_OP_CALL,

	HCC_AST_BINARY_OP_COUNT,
};

typedef uint8_t HccASTUnaryOp;
enum HccASTUnaryOp {
	HCC_AST_UNARY_OP_LOGICAL_NOT,
	HCC_AST_UNARY_OP_BIT_NOT,
	HCC_AST_UNARY_OP_PLUS,
	HCC_AST_UNARY_OP_NEGATE,
	HCC_AST_UNARY_OP_PRE_INCREMENT,
	HCC_AST_UNARY_OP_PRE_DECREMENT,
	HCC_AST_UNARY_OP_POST_INCREMENT,
	HCC_AST_UNARY_OP_POST_DECREMENT,
	HCC_AST_UNARY_OP_DEREF,
	HCC_AST_UNARY_OP_ADDRESS_OF,

	HCC_AST_UNARY_OP_COUNT,
};

extern uint8_t hcc_ast_unary_op_precedence[HCC_AST_UNARY_OP_COUNT];

// ===========================================
//
//
// AML Scalar Data Type Mask
//
//
// ===========================================

typedef uint16_t HccAMLScalarDataTypeMask;
#define HCC_AML_SCALAR_DATA_TYPE_MASK_SET(ptr, aml_intrinsic_type) (*(ptr)) |= (1 << (aml_intrinsic_type))
#define HCC_AML_SCALAR_DATA_TYPE_MASK_UNSET(ptr, aml_intrinsic_type) (*(ptr)) &= ~(1 << (aml_intrinsic_type))
#define HCC_AML_SCALAR_DATA_TYPE_MASK_IS_SET(v, aml_intrinsic_type) ((bool)((v) & (1 << (aml_intrinsic_type))))

HccString hcc_aml_scalar_data_type_mask_string(HccAMLScalarDataTypeMask mask);

// ===========================================
//
//
// Resource Data Type
//
//
// ===========================================

typedef uint8_t HccTextureDim;
enum HccTextureDim {
	HCC_TEXTURE_DIM_1D =    0,
	HCC_TEXTURE_DIM_2D =    1,
	HCC_TEXTURE_DIM_3D =    2,
	HCC_TEXTURE_DIM_CUBE =  3,

	HCC_TEXTURE_DIM_COUNT = 4,
};

typedef uint16_t HccResourceDataType;
enum HccResourceDataType {
	HCC_RESOURCE_DATA_TYPE_BUFFER =    0,
	HCC_RESOURCE_DATA_TYPE_TEXTURE =   1,
	HCC_RESOURCE_DATA_TYPE_SAMPLER =   2,

	HCC_RESOURCE_DATA_TYPE_COUNT =     3,
};

//
// format constants
#define HCC_RESOURCE_DATA_TYPE_TYPE_MASK         0x0003
#define HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_MASK  0x000c
#define HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_SHIFT 2
#define HCC_RESOURCE_DATA_TYPE_AUX_MASK          0xfff0
#define HCC_RESOURCE_DATA_TYPE_AUX_SHIFT         4

//
// format aux constants for HCC_RESOURCE_DATA_TYPE_TEXTURE
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_ARRAY_MASK        0x0010
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_MS_MASK           0x0020
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_MASK             0x00c0
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_SHIFT            6
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_MASK  0x3f00
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_SCALAR_MASK 0x0f00
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_VECTOR_MASK 0x3000
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_SHIFT 8

//
// extraction utilities
#define HCC_RESOURCE_DATA_TYPE_TYPE(type) ((type) & HCC_RESOURCE_DATA_TYPE_TYPE_MASK)
#define HCC_RESOURCE_DATA_TYPE_AUX(type)  (((type) & HCC_RESOURCE_DATA_TYPE_AUX_MASK) >> HCC_RESOURCE_DATA_TYPE_AUX_SHIFT)
#define HCC_RESOURCE_DATA_TYPE_ACCESS_MODE(type) (((type) & HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_MASK) >> HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_SHIFT)
#define HCC_RESOURCE_DATA_TYPE_IS_BUFFER(type) (HCC_RESOURCE_DATA_TYPE_TYPE(type) == HCC_RESOURCE_DATA_TYPE_BUFFER)
#define HCC_RESOURCE_DATA_TYPE_IS_TEXTURE(type) (HCC_RESOURCE_DATA_TYPE_TYPE(type) == HCC_RESOURCE_DATA_TYPE_TEXTURE)
#define HCC_RESOURCE_DATA_TYPE_IS_SAMPLER(type) (HCC_RESOURCE_DATA_TYPE_TYPE(type) == HCC_RESOURCE_DATA_TYPE_SAMPLER)

//
// extraction utilities for HCC_RESOURCE_DATA_TYPE_TEXTURE aux
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_ARRAY(type)        (!!((type) & HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_ARRAY_MASK))
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_MS(type)           (!!((type) & HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_MS_MASK))
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM(type)             (((type) & HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_MASK) >> HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_SHIFT)
#define HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE(type) (((type) & HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_MASK) >> HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_SHIFT)

//
// initialization
#define HCC_RESOURCE_DATA_TYPE_BUFFER(idx, access_mode) \
( \
	HCC_RESOURCE_DATA_TYPE_BUFFER | \
	(((idx) << HCC_RESOURCE_DATA_TYPE_AUX_SHIFT) & HCC_RESOURCE_DATA_TYPE_AUX_MASK) | \
	(((access_mode) << HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_SHIFT) & HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_MASK) \
)

#define HCC_RESOURCE_DATA_TYPE_TEXTURE(dim, intrinsic_type, access_mode, is_array, is_ms) \
( \
	HCC_RESOURCE_DATA_TYPE_TEXTURE | \
	(((dim) << HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_SHIFT) & HCC_RESOURCE_DATA_TYPE_TEXTURE_DIM_MASK) | \
	(((intrinsic_type) << HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_SHIFT) & HCC_RESOURCE_DATA_TYPE_TEXTURE_INTRINSIC_TYPE_MASK) | \
	(((access_mode) << HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_SHIFT) & HCC_RESOURCE_DATA_TYPE_ACCESS_MODE_MASK) | \
	((is_array) ? HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_ARRAY_MASK : 0) | \
	((is_ms) ? HCC_RESOURCE_DATA_TYPE_TEXTURE_IS_MS_MASK : 0) \
)

#define HCC_RESOURCE_DATA_TYPE_ROSAMPLER HCC_RESOURCE_DATA_TYPE_SAMPLER

extern const char* hcc_texture_dim_strings_lower[HCC_TEXTURE_DIM_COUNT];
extern const char* hcc_texture_dim_strings_upper[HCC_TEXTURE_DIM_COUNT];
extern const char* hcc_resource_access_mode_short_strings_lower[HCC_RESOURCE_ACCESS_MODE_COUNT];
extern const char* hcc_resource_access_mode_short_strings_upper[HCC_RESOURCE_ACCESS_MODE_COUNT];
extern const char* hcc_resource_access_mode_short_strings_title[HCC_RESOURCE_ACCESS_MODE_COUNT];

// ===========================================
//
//
// AST Basic Data Type
//
//
// ===========================================

typedef uint8_t HccASTBasicDataType;
enum HccASTBasicDataType {
	HCC_AST_BASIC_DATA_TYPE_VOID =       0,
	HCC_AST_BASIC_DATA_TYPE_BOOL =       1,
	HCC_AST_BASIC_DATA_TYPE_CHAR =       2,
	HCC_AST_BASIC_DATA_TYPE_SCHAR =      3,
	HCC_AST_BASIC_DATA_TYPE_SSHORT =     4,
	HCC_AST_BASIC_DATA_TYPE_SINT =       5,
	HCC_AST_BASIC_DATA_TYPE_SLONG =      6,
	HCC_AST_BASIC_DATA_TYPE_SLONGLONG =  7,
	HCC_AST_BASIC_DATA_TYPE_UCHAR =      8,
	HCC_AST_BASIC_DATA_TYPE_USHORT =     9,
	HCC_AST_BASIC_DATA_TYPE_UINT =      10,
	HCC_AST_BASIC_DATA_TYPE_ULONG =     11,
	HCC_AST_BASIC_DATA_TYPE_ULONGLONG = 12,
	HCC_AST_BASIC_DATA_TYPE_HALF =      13,
	HCC_AST_BASIC_DATA_TYPE_FLOAT =     14,
	HCC_AST_BASIC_DATA_TYPE_DOUBLE =    15,
	HCC_AST_BASIC_DATA_TYPE_COUNT =     16,
};

#define HCC_AST_BASIC_DATA_TYPE_IS_INT(type) ( \
	(type) >= HCC_AST_BASIC_DATA_TYPE_CHAR && \
	(type) <= HCC_AST_BASIC_DATA_TYPE_ULONGLONG \
)
#define HCC_AST_BASIC_DATA_TYPE_IS_SINT(cu, type) \
( \
	( \
		(type) >= HCC_AST_BASIC_DATA_TYPE_SCHAR && \
		(type) <= HCC_AST_BASIC_DATA_TYPE_SLONGLONG \
	) || \
	( \
		(type) == HCC_AST_BASIC_DATA_TYPE_CHAR && \
		!hcc_options_is_char_unsigned((cu)->options) \
	) \
)

#define HCC_AST_BASIC_DATA_TYPE_IS_UINT(cu, type) \
( \
	( \
		(type) >= HCC_AST_BASIC_DATA_TYPE_UCHAR && \
		(type) <= HCC_AST_BASIC_DATA_TYPE_ULONGLONG \
	) || \
	( \
		(type) == HCC_AST_BASIC_DATA_TYPE_CHAR && \
		hcc_options_is_char_unsigned((cu)->options) \
	) \
)
#define HCC_AST_BASIC_DATA_TYPE_IS_FLOAT(type) ((type) == HCC_AST_BASIC_DATA_TYPE_HALF || (type) == HCC_AST_BASIC_DATA_TYPE_FLOAT || (type) == HCC_AST_BASIC_DATA_TYPE_DOUBLE)

extern uint8_t hcc_ast_data_type_basic_type_ranks[HCC_AST_BASIC_DATA_TYPE_COUNT];
extern const char* hcc_ast_data_type_basic_type_strings[HCC_AST_BASIC_DATA_TYPE_COUNT];
extern uint8_t hcc_ast_basic_type_size_and_aligns_x86_64_linux[HCC_AST_BASIC_DATA_TYPE_COUNT];
extern uint64_t hcc_ast_basic_type_int_mins_x86_64_linux[HCC_AST_BASIC_DATA_TYPE_COUNT];
extern uint64_t hcc_ast_basic_type_int_maxes_x86_64_linux[HCC_AST_BASIC_DATA_TYPE_COUNT];

// ===========================================
//
//
// Data Type
//
//
// ===========================================

typedef uint32_t HccDataType;
enum HccDataType {
	HCC_DATA_TYPE_AST_BASIC =            0, // HccASTBasicDataType
	HCC_DATA_TYPE_AML_INTRINSIC =        1, // HccAMLIntrinsicDataType
	HCC_DATA_TYPE_ENUM =                 2, // index for HccDataTypeTable.enum_data_types
	HCC_DATA_TYPE_STRUCT =               3, // index for HccDataTypeTable.compound_data_types
	HCC_DATA_TYPE_UNION =                4, // index for HccDataTypeTable.compound_data_types
	HCC_DATA_TYPE_ARRAY =                5, // index for HccDataTypeTable.array_data_types
	HCC_DATA_TYPE_POINTER =              6, // index for HccDataTypeTable.pointer_data_types
	HCC_DATA_TYPE_TYPEDEF =              7, // index for HccDataTypeTable.typedefs
	HCC_DATA_TYPE_FUNCTION =             8, // index for HccDataTypeTable.functions
	HCC_DATA_TYPE_RESOURCE =             9, // HccResourceDataType
	HCC_DATA_TYPE_RESOURCE_DESCRIPTOR =  10, // HccResourceDataType
	HCC_DATA_TYPE_COUNT =                11,
#define HCC_DATA_TYPE_INVALID HCC_DATA_TYPE_COUNT
};

//
// format constants
#define HCC_DATA_TYPE_TYPE_MASK               0x0000001f // as HCC_AML_OPERAND_COUNT < 32
#define HCC_DATA_TYPE_CONST_QUALIFIER_MASK    0x00000020
#define HCC_DATA_TYPE_VOLATILE_QUALIFIER_MASK 0x00000040
#define HCC_DATA_TYPE_ATOMIC_QUALIFIER_MASK   0x00000080
#define HCC_DATA_TYPE_MUTONLY_QUALIFIER_MASK  0x00000100
#define HCC_DATA_TYPE_QUALIFIERS_MASK         0x000001e0
#define HCC_DATA_TYPE_FORWARD_DECL_MASK       0x00000200 // for HCC_DATA_TYPE_STRUCT, HCC_DATA_TYPE_UNION, HCC_DECL_GLOBAL_VARIABLE, HCC_DECL_FUNCTION
#define HCC_DATA_TYPE_AUX_MASK                0xfffffc00
#define HCC_DATA_TYPE_AUX_SHIFT               10

//
// extraction utilities
#define HCC_DATA_TYPE_TYPE(type)            ((type) & HCC_DATA_TYPE_TYPE_MASK)
#define HCC_DATA_TYPE_AUX(type)             (((type) & HCC_DATA_TYPE_AUX_MASK) >> HCC_DATA_TYPE_AUX_SHIFT)
#define HCC_DATA_TYPE_IS_FORWARD_DECL(type) ((type) & HCC_DATA_TYPE_FORWARD_DECL_MASK)

//
// insertion utilities
#define HCC_DATA_TYPE_CONST(type)            ((type) | HCC_DATA_TYPE_CONST_QUALIFIER_MASK)
#define HCC_DATA_TYPE_MUTONLY(type)          ((type) | HCC_DATA_TYPE_MUTONLY_QUALIFIER_MASK)
#define HCC_DATA_TYPE_VOLATILE(type)         ((type) | HCC_DATA_TYPE_VOLATILE_QUALIFIER_MASK)
#define HCC_DATA_TYPE_ATOMIC(type)           ((type) | HCC_DATA_TYPE_ATOMIC_QUALIFIER_MASK)

//
// removal utilities
#define HCC_DATA_TYPE_STRIP_CONST(type)      ((type) & ~HCC_DATA_TYPE_CONST_QUALIFIER_MASK)
#define HCC_DATA_TYPE_STRIP_MUTONLY(type)    ((type) & ~HCC_DATA_TYPE_MUTONLY_QUALIFIER_MASK)
#define HCC_DATA_TYPE_STRIP_VOLATILE(type)   ((type) & ~HCC_DATA_TYPE_VOLATILE_QUALIFIER_MASK)
#define HCC_DATA_TYPE_STRIP_ATOMIC(type)     ((type) & ~HCC_DATA_TYPE_ATOMIC_QUALIFIER_MASK)
#define HCC_DATA_TYPE_STRIP_QUALIFIERS(type) ((type) & ~HCC_DATA_TYPE_QUALIFIERS_MASK)

//
// initialization
#define HCC_DATA_TYPE(type, aux) ( \
	HCC_DATA_TYPE_##type | \
	((aux) << HCC_DATA_TYPE_AUX_SHIFT) \
)
#define HCC_DATA_TYPE_FORWARD_DECL(type, aux) ( \
	HCC_DATA_TYPE_##type | \
	HCC_DATA_TYPE_FORWARD_DECL_MASK | \
	((aux) << HCC_DATA_TYPE_AUX_SHIFT) \
)
#define HCC_DATA_TYPE_PACKED_AML(aml_intrinsic_data_type) HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_START + (aml_intrinsic_data_type))

//
// comparision utilities
#define HCC_DATA_TYPE_IS_CONST(type)         (!!((type) & HCC_DATA_TYPE_CONST_QUALIFIER_MASK))
#define HCC_DATA_TYPE_IS_MUTONLY(type)       (!!((type) & HCC_DATA_TYPE_MUTONLY_QUALIFIER_MASK))
#define HCC_DATA_TYPE_IS_VOLATILE(type)      (!!((type) & HCC_DATA_TYPE_VOLATILE_QUALIFIER_MASK))
#define HCC_DATA_TYPE_IS_ATOMIC(type)        (!!((type) & HCC_DATA_TYPE_ATOMIC_QUALIFIER_MASK))
#define HCC_DATA_TYPE_IS_AST_BASIC(type)     (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_AST_BASIC)
#define HCC_DATA_TYPE_IS_AML_INTRINSIC(type) (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_AML_INTRINSIC)
#define HCC_DATA_TYPE_IS_ENUM(type)          (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_ENUM)
#define HCC_DATA_TYPE_IS_STRUCT(type)        (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_STRUCT)
#define HCC_DATA_TYPE_IS_UNION(type)         (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_UNION)
#define HCC_DATA_TYPE_IS_ARRAY(type)         (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_ARRAY)
#define HCC_DATA_TYPE_IS_POINTER(type)       (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_POINTER)
#define HCC_DATA_TYPE_IS_TYPEDEF(type)       (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_TYPEDEF)
#define HCC_DATA_TYPE_IS_FUNCTION(type)      (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_FUNCTION)
#define HCC_DATA_TYPE_IS_RESOURCE(type)      (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE)
#define HCC_DATA_TYPE_IS_RESOURCE_DESCRIPTOR(type) (HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE_DESCRIPTOR)
#define HCC_DATA_TYPE_IS_COMPOUND(type)      (HCC_DATA_TYPE_IS_STRUCT(type) || HCC_DATA_TYPE_IS_UNION(type))
#define HCC_DATA_TYPE_IS_COMPOSITE(type)     (HCC_DATA_TYPE_IS_STRUCT(type) || HCC_DATA_TYPE_IS_UNION(type) || HCC_DATA_TYPE_IS_ARRAY(type) || HCC_DATA_TYPE_IS_VECTOR(type))
#define HCC_DATA_TYPE_IS_PACKED_AML(type)    (HCC_DATA_TYPE_IS_STRUCT(type) && HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_START <= HCC_DATA_TYPE_AUX(type) && HCC_DATA_TYPE_AUX(type) < HCC_COMPOUND_DATA_TYPE_IDX_PACKED_AML_END)
#define HCC_DATA_TYPE_IS_VECTOR(type)        (HCC_DATA_TYPE_IS_AML_INTRINSIC(type) && HCC_AML_INTRINSIC_DATA_TYPE_IS_VECTOR(HCC_DATA_TYPE_AUX(type)))
#define HCC_DATA_TYPE_IS_BUFFER(type)        ((HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE || HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE_DESCRIPTOR) && HCC_RESOURCE_DATA_TYPE_IS_BUFFER(HCC_DATA_TYPE_AUX(type)))
#define HCC_DATA_TYPE_IS_TEXTURE(type)       ((HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE || HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE_DESCRIPTOR) && HCC_RESOURCE_DATA_TYPE_IS_TEXTURE(HCC_DATA_TYPE_AUX(type)))
#define HCC_DATA_TYPE_IS_SAMPLER(type)       ((HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE || HCC_DATA_TYPE_TYPE(type) == HCC_DATA_TYPE_RESOURCE_DESCRIPTOR) && HCC_RESOURCE_DATA_TYPE_IS_SAMPLER(HCC_DATA_TYPE_AUX(type)))

#define HCC_DATA_TYPE_AST_BASIC_VOID         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_VOID)
#define HCC_DATA_TYPE_AST_BASIC_BOOL         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_BOOL)
#define HCC_DATA_TYPE_AST_BASIC_CHAR         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_CHAR)
#define HCC_DATA_TYPE_AST_BASIC_SCHAR        HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_SCHAR)
#define HCC_DATA_TYPE_AST_BASIC_SSHORT       HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_SSHORT)
#define HCC_DATA_TYPE_AST_BASIC_SINT         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_SINT)
#define HCC_DATA_TYPE_AST_BASIC_SLONG        HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_SLONG)
#define HCC_DATA_TYPE_AST_BASIC_SLONGLONG    HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_SLONGLONG)
#define HCC_DATA_TYPE_AST_BASIC_UCHAR        HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_UCHAR)
#define HCC_DATA_TYPE_AST_BASIC_USHORT       HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_USHORT)
#define HCC_DATA_TYPE_AST_BASIC_UINT         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_UINT)
#define HCC_DATA_TYPE_AST_BASIC_ULONG        HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_ULONG)
#define HCC_DATA_TYPE_AST_BASIC_ULONGLONG    HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_ULONGLONG)
#define HCC_DATA_TYPE_AST_BASIC_HALF         HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_HALF)
#define HCC_DATA_TYPE_AST_BASIC_FLOAT        HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_FLOAT)
#define HCC_DATA_TYPE_AST_BASIC_DOUBLE       HCC_DATA_TYPE(AST_BASIC, HCC_AST_BASIC_DATA_TYPE_DOUBLE)
#define HCC_DATA_TYPE_HALF                   HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HALF)
#define HCC_DATA_TYPE_AML_INTRINSIC_VOID     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_VOID)
#define HCC_DATA_TYPE_AML_INTRINSIC_BOOL     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_BOOL)
#define HCC_DATA_TYPE_AML_INTRINSIC_S8       HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S8)
#define HCC_DATA_TYPE_AML_INTRINSIC_S16      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S16)
#define HCC_DATA_TYPE_AML_INTRINSIC_S32      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S32)
#define HCC_DATA_TYPE_AML_INTRINSIC_S64      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S64)
#define HCC_DATA_TYPE_AML_INTRINSIC_U8       HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U8)
#define HCC_DATA_TYPE_AML_INTRINSIC_U16      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U16)
#define HCC_DATA_TYPE_AML_INTRINSIC_U32      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U32)
#define HCC_DATA_TYPE_AML_INTRINSIC_U64      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U64)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64      HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64)
#define HCC_DATA_TYPE_AML_INTRINSIC_BOOLX2   HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_BOOLX2)
#define HCC_DATA_TYPE_AML_INTRINSIC_S8X2     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S8X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_S16X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S16X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_S32X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S32X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_S64X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S64X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_U8X2     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U8X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_U16X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U16X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_U32X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U32X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_U64X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U64X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X2    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_BOOLX3   HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_BOOLX3)
#define HCC_DATA_TYPE_AML_INTRINSIC_S8X3     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S8X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_S16X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S16X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_S32X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S32X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_S64X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S64X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_U8X3     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U8X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_U16X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U16X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_U32X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U32X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_U64X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U64X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X3    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_BOOLX4   HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_BOOLX4)
#define HCC_DATA_TYPE_AML_INTRINSIC_S8X4     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S8X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_S16X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S16X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_S32X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S32X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_S64X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_S64X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_U8X4     HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U8X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_U16X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U16X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_U32X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U32X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_U64X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_U64X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X4    HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X2X2  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X2X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X2X3  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X2X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X2X4  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X2X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X3X2  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X3X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X3X3  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X3X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X3X4  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X3X4)
#define HCC_DATA_TYPE_AML_INTRINSIC_F16X4X2  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F16X4X2)
#define HCC_DATA_TYPE_AML_INTRINSIC_F32X4X3  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F32X4X3)
#define HCC_DATA_TYPE_AML_INTRINSIC_F64X4X4  HCC_DATA_TYPE(AML_INTRINSIC, HCC_AML_INTRINSIC_DATA_TYPE_F64X4X4)
#define HCC_DATA_TYPE_HCC_VERTEX_SV          HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HCC_VERTEX_SV)
#define HCC_DATA_TYPE_HCC_VERTEX_SV_OUT      HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HCC_VERTEX_SV_OUT)
#define HCC_DATA_TYPE_HCC_PIXEL_SV        HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HCC_PIXEL_SV)
#define HCC_DATA_TYPE_HCC_PIXEL_SV_OUT    HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HCC_PIXEL_SV_OUT)
#define HCC_DATA_TYPE_HCC_COMPUTE_SV         HCC_DATA_TYPE(STRUCT, HCC_COMPOUND_DATA_TYPE_IDX_HCC_COMPUTE_SV)
#define HCC_DATA_TYPE_ROSAMPLER              HCC_DATA_TYPE(RESOURCE, HCC_RESOURCE_DATA_TYPE_ROSAMPLER)

// ===========================================
//
//
// Declarations
//
//
// ===========================================

//
// inherits HccDataType
typedef uint32_t HccDecl;
enum HccDecl {
	HCC_DECL_FUNCTION = HCC_DATA_TYPE_COUNT,
	HCC_DECL_ENUM_VALUE,
	HCC_DECL_LOCAL_VARIABLE,
	HCC_DECL_GLOBAL_VARIABLE,

	HCC_DECL_COUNT,
};

//
// initialization
#define HCC_DECL(type, aux) ( \
	HCC_DECL_##type | \
	((aux) << HCC_DATA_TYPE_AUX_SHIFT) \
)
#define HCC_DECL_FORWARD_DECL(type, aux) ( \
	HCC_DECL_##type | \
	HCC_DATA_TYPE_FORWARD_DECL_MASK | \
	((aux) << HCC_DATA_TYPE_AUX_SHIFT) \
)

static_assert(HCC_DECL_COUNT <= HCC_DATA_TYPE_TYPE_MASK + 1, "HccDecl type overflows the type mask in HccDataType");

//
// comparison utilities
#define HCC_DECL_IS_DATA_TYPE(decl) (HCC_DATA_TYPE_TYPE(decl) < HCC_DATA_TYPE_COUNT)
#define HCC_DECL_IS_FUNCTION(decl) (HCC_DATA_TYPE_TYPE(decl) == HCC_DECL_FUNCTION)
#define HCC_DECL_IS_ENUM_VALUE(decl) (HCC_DATA_TYPE_TYPE(decl) == HCC_DECL_ENUM_VALUE)
#define HCC_DECL_IS_LOCAL_VARIABLE(decl) (HCC_DATA_TYPE_TYPE(decl) == HCC_DECL_LOCAL_VARIABLE)
#define HCC_DECL_IS_GLOBAL_VARIABLE(decl) (HCC_DATA_TYPE_TYPE(decl) == HCC_DECL_GLOBAL_VARIABLE)
#define HCC_DECL_IS_FORWARD_DECL(decl) HCC_DATA_TYPE_IS_FORWARD_DECL(decl)

#define HCC_DECL_TYPE(decl) HCC_DATA_TYPE_TYPE(decl)
#define HCC_DECL_AUX(decl) HCC_DATA_TYPE_AUX(decl)

HccDecl hcc_decl_resolve_and_keep_qualifiers(HccCU* cu, HccDecl decl);
HccDecl hcc_decl_resolve_and_strip_qualifiers(HccCU* cu, HccDecl decl);
HccDataType hcc_decl_function_data_type(HccCU* cu, HccDecl decl);
HccDecl hcc_decl_return_data_type(HccCU* cu, HccDecl decl);
uint8_t hcc_decl_function_params_count(HccCU* cu, HccDecl decl);
HccASTVariable* hcc_decl_function_params(HccCU* cu, HccDecl decl);
HccShaderStage hcc_decl_function_shader_stage(HccCU* cu, HccDecl decl);
HccStringId hcc_decl_identifier_string_id(HccCU* cu, HccDecl decl);
HccLocation* hcc_decl_location(HccCU* cu, HccDecl decl);

// ===========================================
//
//
// Data Type Table
//
//
// ===========================================

typedef struct HccDataTypeTable HccDataTypeTable;
typedef struct HccArrayDataType HccArrayDataType;
typedef struct HccBufferDataType HccBufferDataType;
typedef struct HccPointerDataType HccPointerDataType;
typedef struct HccFunctionDataType HccFunctionDataType;
typedef struct HccCompoundDataType HccCompoundDataType;
typedef struct HccCompoundField HccCompoundField;
typedef struct HccEnumDataType HccEnumDataType;
typedef struct HccEnumValue HccEnumValue;
typedef struct HccTypedef HccTypedef;

typedef struct HccDataTypeTableSetup HccDataTypeTableSetup;
struct HccDataTypeTableSetup {
	uint32_t arrays_grow_count;
	uint32_t arrays_reserve_cap;
	uint32_t compounds_grow_count;
	uint32_t compounds_reserve_cap;
	uint32_t compound_fields_grow_count;
	uint32_t compound_fields_reserve_cap;
	uint32_t typedefs_grow_count;
	uint32_t typedefs_reserve_cap;
	uint32_t enums_grow_count;
	uint32_t enums_reserve_cap;
	uint32_t enum_values_grow_count;
	uint32_t enum_values_reserve_cap;
	uint32_t pointers_grow_count;
	uint32_t pointers_reserve_cap;
	uint32_t buffers_grow_count;
	uint32_t buffers_reserve_cap;
};

typedef uint8_t HccBasicTypeClass;
enum HccBasicTypeClass {
	HCC_BASIC_TYPE_CLASS_VOID,
	HCC_BASIC_TYPE_CLASS_BOOL,
	HCC_BASIC_TYPE_CLASS_UINT,
	HCC_BASIC_TYPE_CLASS_SINT,
	HCC_BASIC_TYPE_CLASS_FLOAT,

	HCC_BASIC_TYPE_CLASS_COUNT,
};

typedef union HccBasic HccBasic;
union HccBasic {
	int8_t   s8;
	int16_t  s16;
	int32_t  s32;
	int64_t  s64;
	uint8_t  u8;
	uint16_t u16;
	uint32_t u32;
	uint64_t u64;
	float    f32;
	double   f64;
};

typedef uint8_t HccCanCast;
enum HccCanCast {
	HCC_CAN_CAST_YES,
	HCC_CAN_CAST_NO_DIFFERENT_TYPES,
	HCC_CAN_CAST_NO_SAME_TYPES,
};

HccString hcc_data_type_string(HccCU* cu, HccDataType data_type);
void hcc_data_type_size_align(HccCU* cu, HccDataType data_type, uint64_t* size_out, uint64_t* align_out);
void hcc_data_type_print_basic(HccCU* cu, HccDataType data_type, void* data, HccIIO* iio);
bool hcc_data_type_is_condition(HccDataType data_type);
uint64_t hcc_data_type_composite_fields_count(HccCU* cu, HccDataType data_type);
uint64_t hcc_data_type_composite_storage_fields_count(HccCU* cu, HccDataType data_type);
uint64_t hcc_data_type_composite_scalar_start_idx_recursive(HccCU* cu, HccDataType data_type, uint64_t* elmt_indices, uint32_t elmt_indices_count, HccDataType* final_composite_data_type_out);
void hcc_data_type_composite_splat_constants_recursive(HccCU* cu, HccDataType data_type, HccConstantId constant_id, HccConstantId* dst_constant_ids);
bool hcc_data_type_is_rasterizer_state(HccCU* cu, HccDataType data_type);
bool hcc_data_type_is_pixel_state(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_strip_pointer(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_strip_all_pointers(HccCU* cu, HccDataType data_type);
HccLocation* hcc_data_type_location(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_lower_ast_to_aml(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_higher_aml_to_ast(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_signed_to_unsigned(HccCU* cu, HccDataType data_type);
HccDataType hcc_data_type_unsigned_to_signed(HccCU* cu, HccDataType data_type);
HccCanCast hcc_data_type_can_cast(HccCU* cu, HccDataType dst_data_type, HccDataType src_data_type);
HccAMLScalarDataTypeMask hcc_data_type_scalar_data_types_mask(HccCU* cu, HccDataType data_type);
uint64_t hcc_data_type_scalars_count_recursive(HccCU* cu, HccDataType data_type);

HccBasicTypeClass hcc_basic_type_class(HccCU* cu, HccDataType data_type);
HccBasic hcc_basic_eval_unary(HccCU* cu, HccASTUnaryOp unary_op, HccDataType data_type, HccBasic eval);
HccBasic hcc_basic_eval_binary(HccCU* cu, HccASTBinaryOp binary_op, HccDataType data_type, HccBasic left_eval, HccBasic right_eval);
bool hcc_basic_as_bool(HccCU* cu, HccDataType data_type, HccBasic basic);
HccBasic hcc_basic_from_sint(HccCU* cu, HccDataType data_type, int64_t value);
HccBasic hcc_basic_from_uint(HccCU* cu, HccDataType data_type, uint64_t value);
HccBasic hcc_basic_from_float(HccCU* cu, HccDataType data_type, double value);

HccArrayDataType* hcc_array_data_type_get(HccCU* cu, HccDataType data_type);
HccDataType hcc_array_data_type_element_data_type(HccArrayDataType* dt);
HccConstantId hcc_array_data_type_element_count_constant_id(HccArrayDataType* dt);
uint64_t hcc_array_data_type_element_count(HccCU* cu, HccArrayDataType* dt);
HccDataType hcc_array_data_type_deduplicate(HccCU* cu, HccDataType element_data_type, HccConstantId element_count_constant_id);

HccBufferDataType* hcc_buffer_data_type_get(HccCU* cu, HccDataType data_type);
HccDataType hcc_buffer_data_type_element_data_type(HccBufferDataType* dt);

HccPointerDataType* hcc_pointer_data_type_get(HccCU* cu, HccDataType data_type);
HccDataType hcc_pointer_data_type_element_data_type(HccPointerDataType* dt);
HccDataType hcc_pointer_data_type_deduplicate(HccCU* cu, HccDataType element_data_type);

HccFunctionDataType* hcc_function_data_type_get(HccCU* cu, HccDataType data_type);
HccDataType hcc_function_data_type_return_data_type(HccFunctionDataType* dt);
uint32_t hcc_function_data_type_params_count(HccFunctionDataType* dt);
HccDataType* hcc_function_data_type_params(HccFunctionDataType* dt);
HccDataType hcc_function_data_type_deduplicate(HccCU* cu, HccDataType return_data_type, HccDataType* params, uint32_t params_count, uintptr_t params_stride);

HccCompoundDataType* hcc_compound_data_type_get(HccCU* cu, HccDataType data_type);
bool hcc_compound_data_type_is_struct(HccCompoundDataType* dt);
bool hcc_compound_data_type_is_union(HccCompoundDataType* dt);
HccLocation* hcc_compound_data_type_identifier_location(HccCompoundDataType* dt);
HccStringId hcc_compound_data_type_identifier_string_id(HccCompoundDataType* dt);
HccCompoundField* hcc_compound_data_type_fields(HccCompoundDataType* dt, uint32_t* fields_count_out);
void hcc_compound_data_type_size_align(HccCompoundDataType* dt, uint64_t* size_out, uint64_t* align_out);

HccLocation* hcc_compound_field_identifier_location(HccCompoundField* field);
HccStringId hcc_compound_field_identifier_string_id(HccCompoundField* field);
HccDataType hcc_compound_field_data_type(HccCompoundField* field);

HccEnumDataType* hcc_enum_data_type_get(HccCU* cu, HccDataType data_type);
HccLocation* hcc_enum_data_type_identifier_location(HccEnumDataType* dt);
HccStringId hcc_enum_data_type_identifier_string_id(HccEnumDataType* dt);
HccEnumValue* hcc_enum_data_type_values(HccEnumDataType* dt, uint32_t* values_count_out);

HccEnumValue* hcc_enum_value_get(HccCU* cu, HccDecl decl);
HccLocation* hcc_enum_value_identifier_location(HccEnumValue* value);
HccStringId hcc_enum_value_identifier_string_id(HccEnumValue* value);
HccConstantId hcc_enum_value_constant_id(HccEnumValue* value);
int32_t hcc_enum_value(HccCU* cu, HccEnumValue* value);

HccTypedef* hcc_typedef_get(HccCU* cu, HccDataType data_type);
HccLocation* hcc_typedef_identifier_location(HccTypedef* dt);
HccStringId hcc_typedef_identifier_string_id(HccTypedef* dt);
HccDataType hcc_typedef_aliased_data_type(HccTypedef* dt);

// ===========================================
//
//
// Constant
//
//
// ===========================================

typedef struct HccConstantTableSetup HccConstantTableSetup;
struct HccConstantTableSetup {
	uint32_t data_grow_size;
	uint32_t data_reserve_size;
	uint32_t entries_cap;
};

typedef struct HccConstant HccConstant;
struct HccConstant {
	void*       data;
	uint32_t    size: 31;
	uint32_t    is_zero: 1;
	HccDataType data_type;
};

void hcc_constant_print(HccCU* cu, HccConstantId constant_id, HccIIO* iio);
bool hcc_constant_as_uint(HccCU* cu, HccConstant constant, uint64_t* out);
bool hcc_constant_as_sint(HccCU* cu, HccConstant constant, int64_t* out);
bool hcc_constant_as_sint32(HccCU* cu, HccConstant constant, int32_t* out);
bool hcc_constant_as_float(HccCU* cu, HccConstant constant, double* out);
bool hcc_constant_is_zero(HccCU* cu, HccConstantId constant_id);

// ===========================================
//
//
// Constant Table
//
//
// ===========================================

HccConstantId hcc_constant_table_deduplicate_basic(HccCU* cu, HccDataType data_type, HccBasic* basic);
HccConstantId hcc_constant_table_deduplicate_composite(HccCU* cu, HccDataType data_type, HccConstantId* fields, uint32_t fields_count);
HccConstantId hcc_constant_table_deduplicate_bytes(HccCU* cu, HccDataType data_type, uint8_t* data, uint32_t size);
HccConstantId hcc_constant_table_deduplicate_composite_recursive(HccCU* cu, HccDataType data_type, HccConstantId* flat_scalar_constant_ids);
HccConstantId hcc_constant_table_deduplicate_zero(HccCU* cu, HccDataType data_type);
HccConstantId hcc_constant_table_deduplicate_one(HccCU* cu, HccDataType data_type);
HccConstantId hcc_constant_table_deduplicate_minus_one(HccCU* cu, HccDataType data_type);
HccConstant hcc_constant_table_get(HccCU* cu, HccConstantId id);
HccBasic hcc_constant_table_get_basic(HccCU* cu, HccConstantId id);

// ===========================================
//
//
// AST Declarations
//
//
// ===========================================

typedef struct HccASTFunction HccASTFunction;

typedef uint8_t HccASTExprType;
enum {
	HCC_AST_EXPR_TYPE_NONE,

	HCC_AST_EXPR_TYPE_CURLY_INITIALIZER,
	HCC_AST_EXPR_TYPE_DESIGNATED_INITIALIZER,
	HCC_AST_EXPR_TYPE_CAST,

	HCC_AST_EXPR_TYPE_LOCAL_VARIABLE,
	HCC_AST_EXPR_TYPE_GLOBAL_VARIABLE,

	HCC_AST_EXPR_TYPE_CONSTANT,
	HCC_AST_EXPR_TYPE_DATA_TYPE,
	HCC_AST_EXPR_TYPE_FUNCTION,
	HCC_AST_EXPR_TYPE_BINARY_OP,
	HCC_AST_EXPR_TYPE_UNARY_OP,

	HCC_AST_EXPR_TYPE_STMT_IF,
	HCC_AST_EXPR_TYPE_STMT_SWITCH,
	HCC_AST_EXPR_TYPE_STMT_WHILE,
	HCC_AST_EXPR_TYPE_STMT_FOR,
	HCC_AST_EXPR_TYPE_STMT_CASE,
	HCC_AST_EXPR_TYPE_STMT_DEFAULT,
	HCC_AST_EXPR_TYPE_STMT_BREAK,
	HCC_AST_EXPR_TYPE_STMT_CONTINUE,
	HCC_AST_EXPR_TYPE_STMT_RETURN,
	HCC_AST_EXPR_TYPE_STMT_BLOCK,
	HCC_AST_EXPR_TYPE_STMT_GENERIC_CASE,
};

typedef struct HccASTExpr HccASTExpr;
struct HccASTExpr {
	union {
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
		};
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccDecl         decl;
		} function;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTUnaryOp   op;
			HccASTExpr*     expr;
		} unary;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTBinaryOp  op;
			bool            is_bitfield;
			bool            is_swizzle;
			HccASTExpr*     left_expr;
			union {
				HccASTExpr* right_expr;
				uint32_t    field_idx;
			};
		} binary;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccConstantId   id;
		} constant;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     first_stmt;
			HccASTExpr*     last_stmt;
		} stmt_block;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     expr;
		} return_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     expr;
		} cast_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     first_expr;
		} curly_initializer;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     value_expr;
			uint32_t        elmt_indices_start_idx; // index into HccAST.designated_initializer_elmt_indices
			uint32_t        elmts_count;
			bool            is_swizzle;
			bool            is_bitfield;
		} designated_initializer;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     cond_expr;
			HccASTExpr*     true_stmt;
			HccASTExpr*     false_stmt;
		} if_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     cond_expr;
			HccASTExpr*     block_expr;
			uint32_t        case_stmts_count: 31;
			uint32_t        has_default_case: 1;
		} switch_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     next_case_stmt;
			HccConstantId   constant_id;
		} case_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     cond_expr;
			HccASTExpr*     loop_stmt;
		} while_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     init_stmt;
			HccASTExpr*     cond_expr;
			HccASTExpr*     inc_stmt;
			HccASTExpr*     loop_stmt;
		} for_;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccDecl         decl;
		} variable;
		struct {
			HccASTExprType  type: 7;
			uint8_t         is_stmt: 1;
			HccASTExpr*     next_case_stmt;
			HccASTExpr*     expr;
			HccDataType     data_type;
		} generic_case;
	};

	HccLocation* location;
	HccASTExpr* next_stmt;
	HccDataType data_type;
};

//
// tracking information for forward declarations inside an HccASTFile for:
//    - struct's, union's and external global variable declarations 'extern T var;' and functions.
// later these will be resolved using hcc_decl_resolve_* functions.
typedef struct HccASTForwardDecl HccASTForwardDecl;
struct HccASTForwardDecl {
	HccASTFile*  ast_file;
	HccLocation* identifier_location;
	HccStringId  identifier_string_id;

	union {
		struct {
			HccDataType data_type;
		} variable;
		struct {
			HccDataType     function_data_type;
			HccASTVariable* params;
			uint32_t        params_count;
			HccDataType     return_data_type;
		} function;
	};
};

typedef uint8_t HccASTStorageDuration;
enum {
	HCC_AST_STORAGE_DURATION_STATIC,
	HCC_AST_STORAGE_DURATION_THREAD,
	HCC_AST_STORAGE_DURATION_AUTOMATIC,
	HCC_AST_STORAGE_DURATION_DISPATCH_GROUP,
};

typedef uint8_t HccASTLinkage;
enum {
	HCC_AST_LINKAGE_EXTERNAL = 0,
	HCC_AST_LINKAGE_INTERNAL = 1,
};

extern const char* hcc_ast_function_shader_stage_strings[HCC_SHADER_STAGE_COUNT];

HccASTForwardDecl* hcc_ast_forward_decl_get(HccCU* cu, HccDecl decl);

HccASTVariable* hcc_ast_global_variable_get(HccCU* cu, HccDecl decl);
HccLocation* hcc_ast_variable_identifier_location(HccASTVariable* variable);
HccStringId hcc_ast_variable_identifier_string_id(HccASTVariable* variable);
HccDataType hcc_ast_variable_data_type(HccASTVariable* variable);
HccASTLinkage hcc_ast_variable_linkage(HccASTVariable* variable);
HccASTStorageDuration hcc_ast_variable_storage_duration(HccASTVariable* variable);
HccConstantId hcc_ast_variable_initializer_constant_id(HccASTVariable* variable);
void hcc_ast_variable_to_string(HccCU* cu, HccDataType data_type, HccStringId identifier_string_id, HccIIO* iio);

HccASTFunction* hcc_ast_function_get(HccCU* cu, HccDecl decl);
HccShaderStage hcc_ast_function_shader_stage(HccASTFunction* function);
bool hcc_ast_function_is_inline(HccASTFunction* function);
HccASTLinkage hcc_ast_function_linkage(HccASTFunction* function);
HccLocation* hcc_ast_function_identifier_location(HccASTFunction* function);
HccStringId hcc_ast_function_identifier_string_id(HccASTFunction* function);
HccDataType hcc_ast_function_return_data_type(HccASTFunction* function);
HccLocation* hcc_ast_function_return_data_type_location(HccASTFunction* function);
uint8_t hcc_ast_function_params_count(HccASTFunction* function);
uint16_t hcc_ast_function_variables_count(HccASTFunction* function);
HccASTVariable* hcc_ast_function_params_and_variables(HccASTFunction* function);
HccASTExpr* hcc_ast_function_block_expr(HccASTFunction* function);
void hcc_ast_function_to_string(HccCU* cu, HccDecl function_decl, HccIIO* iio);
const char* hcc_ast_function_callstack_string(HccCU* cu, HccDecl* function_decls, uint32_t functions_count);

// ===========================================
//
//
// Preprocessor
//
//
// ===========================================

typedef struct HccPPMacro HccPPMacro;

HccStringId hcc_pp_macro_get_identifier_string_id(HccPPMacro* macro);
HccString hcc_pp_macro_get_identifier_string(HccPPMacro* macro);
HccLocation* hcc_pp_macro_get_location(HccPPMacro* macro);
HccStringId* hcc_pp_macro_get_params(HccPPMacro* macro, uint32_t* params_count_out);

// ===========================================
//
//
// ATA Token
//
//
// ===========================================

#define HCC_ATA_TOKEN_IDX_INVALID UINT32_MAX

typedef uint8_t HccATAToken;
enum {
	HCC_ATA_TOKEN_EOF,
	HCC_ATA_TOKEN_IDENT,
	HCC_ATA_TOKEN_STRING,
	HCC_ATA_TOKEN_INCLUDE_PATH_SYSTEM,
	HCC_ATA_TOKEN_BACK_SLASH,
	HCC_ATA_TOKEN_HASH,
	HCC_ATA_TOKEN_DOUBLE_HASH,
	HCC_ATA_TOKEN_MACRO_WHITESPACE,
	HCC_ATA_TOKEN_MACRO_PARAM,
	HCC_ATA_TOKEN_MACRO_STRINGIFY,
	HCC_ATA_TOKEN_MACRO_STRINGIFY_WHITESPACE,
	HCC_ATA_TOKEN_MACRO_CONCAT,
	HCC_ATA_TOKEN_MACRO_CONCAT_WHITESPACE,

	//
	// symbols
	//
#define HCC_ATA_TOKEN_BRACKET_START HCC_ATA_TOKEN_CURLY_OPEN
	HCC_ATA_TOKEN_CURLY_OPEN,
	HCC_ATA_TOKEN_CURLY_CLOSE,
	HCC_ATA_TOKEN_PARENTHESIS_OPEN,
	HCC_ATA_TOKEN_PARENTHESIS_CLOSE,
	HCC_ATA_TOKEN_SQUARE_OPEN,
	HCC_ATA_TOKEN_SQUARE_CLOSE,
#define HCC_ATA_TOKEN_BRACKET_END   (HCC_ATA_TOKEN_SQUARE_CLOSE + 1)
#define HCC_ATA_TOKEN_BRACKET_COUNT (HCC_ATA_TOKEN_BRACKET_END - HCC_ATA_TOKEN_BRACKET_START)

	HCC_ATA_TOKEN_FULL_STOP,
	HCC_ATA_TOKEN_COMMA,
	HCC_ATA_TOKEN_SEMICOLON,
	HCC_ATA_TOKEN_COLON,
	HCC_ATA_TOKEN_PLUS,
	HCC_ATA_TOKEN_MINUS,
	HCC_ATA_TOKEN_FORWARD_SLASH,
	HCC_ATA_TOKEN_ASTERISK,
	HCC_ATA_TOKEN_PERCENT,
	HCC_ATA_TOKEN_AMPERSAND,
	HCC_ATA_TOKEN_PIPE,
	HCC_ATA_TOKEN_CARET,
	HCC_ATA_TOKEN_EXCLAMATION_MARK,
	HCC_ATA_TOKEN_QUESTION_MARK,
	HCC_ATA_TOKEN_TILDE,
	HCC_ATA_TOKEN_EQUAL,
	HCC_ATA_TOKEN_LESS_THAN,
	HCC_ATA_TOKEN_GREATER_THAN,

	//
	// grouped symbols
	//
	HCC_ATA_TOKEN_LOGICAL_AND,
	HCC_ATA_TOKEN_LOGICAL_OR,
	HCC_ATA_TOKEN_LOGICAL_EQUAL,
	HCC_ATA_TOKEN_LOGICAL_NOT_EQUAL,
	HCC_ATA_TOKEN_LESS_THAN_OR_EQUAL,
	HCC_ATA_TOKEN_GREATER_THAN_OR_EQUAL,
	HCC_ATA_TOKEN_BIT_SHIFT_LEFT,
	HCC_ATA_TOKEN_BIT_SHIFT_RIGHT,
	HCC_ATA_TOKEN_ADD_ASSIGN,
	HCC_ATA_TOKEN_SUBTRACT_ASSIGN,
	HCC_ATA_TOKEN_MULTIPLY_ASSIGN,
	HCC_ATA_TOKEN_DIVIDE_ASSIGN,
	HCC_ATA_TOKEN_MODULO_ASSIGN,
	HCC_ATA_TOKEN_BIT_SHIFT_LEFT_ASSIGN,
	HCC_ATA_TOKEN_BIT_SHIFT_RIGHT_ASSIGN,
	HCC_ATA_TOKEN_BIT_AND_ASSIGN,
	HCC_ATA_TOKEN_BIT_XOR_ASSIGN,
	HCC_ATA_TOKEN_BIT_OR_ASSIGN,
	HCC_ATA_TOKEN_INCREMENT,
	HCC_ATA_TOKEN_DECREMENT,
	HCC_ATA_TOKEN_ARROW_RIGHT,

#define HCC_ATA_TOKEN_LIT_NUMBERS_START HCC_ATA_TOKEN_LIT_UINT
	HCC_ATA_TOKEN_LIT_UINT,
	HCC_ATA_TOKEN_LIT_ULONG,
	HCC_ATA_TOKEN_LIT_ULONGLONG,
	HCC_ATA_TOKEN_LIT_SINT,
	HCC_ATA_TOKEN_LIT_SLONG,
	HCC_ATA_TOKEN_LIT_SLONGLONG,
	HCC_ATA_TOKEN_LIT_FLOAT,
	HCC_ATA_TOKEN_LIT_DOUBLE,
#define HCC_ATA_TOKEN_LIT_NUMBERS_END (HCC_ATA_TOKEN_LIT_DOUBLE + 1)

	//
	// keywords
	//
#define HCC_ATA_TOKEN_KEYWORDS_START HCC_ATA_TOKEN_KEYWORD_VOID
	HCC_ATA_TOKEN_KEYWORD_VOID,
	HCC_ATA_TOKEN_KEYWORD_BOOL,
	HCC_ATA_TOKEN_KEYWORD_CHAR,
	HCC_ATA_TOKEN_KEYWORD_SHORT,
	HCC_ATA_TOKEN_KEYWORD_INT,
	HCC_ATA_TOKEN_KEYWORD_LONG,
	HCC_ATA_TOKEN_KEYWORD_FLOAT,
	HCC_ATA_TOKEN_KEYWORD_DOUBLE,
	HCC_ATA_TOKEN_KEYWORD_UNSIGNED,
	HCC_ATA_TOKEN_KEYWORD_SIGNED,
	HCC_ATA_TOKEN_KEYWORD_COMPLEX,
	HCC_ATA_TOKEN_KEYWORD_ATOMIC,
	HCC_ATA_TOKEN_KEYWORD_RETURN,
	HCC_ATA_TOKEN_KEYWORD_IF,
	HCC_ATA_TOKEN_KEYWORD_ELSE,
	HCC_ATA_TOKEN_KEYWORD_DO,
	HCC_ATA_TOKEN_KEYWORD_WHILE,
	HCC_ATA_TOKEN_KEYWORD_FOR,
	HCC_ATA_TOKEN_KEYWORD_SWITCH,
	HCC_ATA_TOKEN_KEYWORD_CASE,
	HCC_ATA_TOKEN_KEYWORD_DEFAULT,
	HCC_ATA_TOKEN_KEYWORD_BREAK,
	HCC_ATA_TOKEN_KEYWORD_CONTINUE,
	HCC_ATA_TOKEN_KEYWORD_TRUE,
	HCC_ATA_TOKEN_KEYWORD_FALSE,
	HCC_ATA_TOKEN_KEYWORD_VERTEX,
	HCC_ATA_TOKEN_KEYWORD_PIXEL,
	HCC_ATA_TOKEN_KEYWORD_COMPUTE,
	HCC_ATA_TOKEN_KEYWORD_MESHTASK,
	HCC_ATA_TOKEN_KEYWORD_MESH,
	HCC_ATA_TOKEN_KEYWORD_ENUM,
	HCC_ATA_TOKEN_KEYWORD_STRUCT,
	HCC_ATA_TOKEN_KEYWORD_UNION,
	HCC_ATA_TOKEN_KEYWORD_TYPEDEF,
	HCC_ATA_TOKEN_KEYWORD_STATIC,
	HCC_ATA_TOKEN_KEYWORD_CONST,
	HCC_ATA_TOKEN_KEYWORD_MUTONLY,
	HCC_ATA_TOKEN_KEYWORD_AUTO,
	HCC_ATA_TOKEN_KEYWORD_REGISTER,
	HCC_ATA_TOKEN_KEYWORD_VOLATILE,
	HCC_ATA_TOKEN_KEYWORD_EXTERN,
	HCC_ATA_TOKEN_KEYWORD_THREAD_LOCAL,
	HCC_ATA_TOKEN_KEYWORD_DISPATCH_GROUP,
	HCC_ATA_TOKEN_KEYWORD_INLINE,
	HCC_ATA_TOKEN_KEYWORD_NO_RETURN,
	HCC_ATA_TOKEN_KEYWORD_SIZEOF,
	HCC_ATA_TOKEN_KEYWORD_ALIGNOF,
	HCC_ATA_TOKEN_KEYWORD_ALIGNAS,
	HCC_ATA_TOKEN_KEYWORD_STATIC_ASSERT,
	HCC_ATA_TOKEN_KEYWORD_GENERIC,
	HCC_ATA_TOKEN_KEYWORD_RESTRICT,
	HCC_ATA_TOKEN_KEYWORD_HALF_T,
	HCC_ATA_TOKEN_KEYWORD_VECTOR_T,
	HCC_ATA_TOKEN_KEYWORD_RASTERIZER_STATE,
	HCC_ATA_TOKEN_KEYWORD_PIXEL_STATE,
	HCC_ATA_TOKEN_KEYWORD_INTERP,
	HCC_ATA_TOKEN_KEYWORD_NOINTERP,
	HCC_ATA_TOKEN_KEYWORD_ROSAMPLER,
	HCC_ATA_TOKEN_KEYWORD_ROBUFFER,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE1D,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE1DARRAY,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE2D,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE2DARRAY,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE2DMS,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE2DMSARRAY,
	HCC_ATA_TOKEN_KEYWORD_ROTEXTURE3D,
	HCC_ATA_TOKEN_KEYWORD_WOBUFFER,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE1D,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE1DARRAY,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE2D,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE2DARRAY,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE2DMS,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE2DMSARRAY,
	HCC_ATA_TOKEN_KEYWORD_WOTEXTURE3D,
	HCC_ATA_TOKEN_KEYWORD_RWBUFFER,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE1D,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE1DARRAY,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE2D,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE2DARRAY,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE2DMS,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE2DMSARRAY,
	HCC_ATA_TOKEN_KEYWORD_RWTEXTURE3D,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURE1D,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURE1DARRAY,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURE2D,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURE2DARRAY,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURECUBE,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURECUBEARRAY,
	HCC_ATA_TOKEN_KEYWORD_SAMPLETEXTURE3D,
#define HCC_ATA_TOKEN_KEYWORDS_END HCC_ATA_TOKEN_COUNT
#define HCC_ATA_TOKEN_KEYWORDS_COUNT (HCC_ATA_TOKEN_KEYWORDS_END - HCC_ATA_TOKEN_KEYWORDS_START)
#define HCC_ATA_TOKEN_IS_KEYWORD(token) (HCC_ATA_TOKEN_KEYWORDS_START <= (token) && (token) < HCC_ATA_TOKEN_KEYWORDS_END)
#define HCC_ATA_TOKEN_IS_LIT_NUMBER(token) (HCC_ATA_TOKEN_LIT_NUMBERS_START <= (token) && (token) < HCC_ATA_TOKEN_LIT_NUMBERS_END)

	HCC_ATA_TOKEN_COUNT,
};

extern const char* hcc_ata_token_strings[HCC_ATA_TOKEN_COUNT];

bool hcc_ata_token_has_value(HccATAToken token);
uint32_t hcc_ata_token_num_values(HccATAToken token);
bool hcc_ata_token_concat_is_okay(HccATAToken before, HccATAToken after);

// ===========================================
//
//
// ATA Value
//
//
// ===========================================

typedef union HccATAValue HccATAValue;
union HccATAValue {
	HccConstantId constant_id;
	HccStringId   string_id;
	uint32_t      macro_param_idx;
};
static_assert(sizeof(HccATAValue) == sizeof(uint32_t), "HccATAValue has been designed around being 32 bits!");
#define HccATAValue(raw) ((HccATAValue){ { raw } })

// ===========================================
//
//
// ATA Iterator
//
//
// ===========================================

typedef struct HccATAIter HccATAIter;

HccATAIter* hcc_ata_iter_start(HccASTFile* file);
void hcc_ata_iter_finish(HccASTFile* file, HccATAIter* iter);

HccATAToken hcc_ata_iter_next(HccATAIter* iter);
HccATAToken hcc_ata_iter_peek(HccATAIter* iter);
HccATAToken hcc_ata_iter_peek_ahead(HccATAIter* iter, uint32_t by);
HccLocation* hcc_ata_iter_location(HccATAIter* iter);
HccATAValue hcc_ata_iter_next_value(HccATAIter* iter);
HccATAValue hcc_ata_iter_peek_value(HccATAIter* iter);

// ===========================================
//
//
// AST File
//
//
// ===========================================

typedef struct HccASTFile HccASTFile;

typedef struct HccASTFileSetup HccASTFileSetup;
struct HccASTFileSetup {
	uint32_t macros_grow_count;
	uint32_t macros_reserve_cap;
	uint32_t macro_params_grow_count;
	uint32_t macro_params_reserve_cap;
	uint32_t tokens_grow_count;
	uint32_t tokens_reserve_cap;
	uint32_t values_grow_count;
	uint32_t values_reserve_cap;
	uint32_t unique_include_files_grow_count;
	uint32_t unique_include_files_reserve_cap;
	uint32_t forward_declarations_to_link_grow_count;
	uint32_t forward_declarations_to_link_reserve_cap;
};

HccString hcc_ast_file_get_path(HccASTFile* file);
HccPPMacro* hcc_ast_file_get_macros(HccASTFile* file, uint32_t* macros_count_out);
HccATAIter* hcc_ast_file_get_ata_iter(HccASTFile* file);
HccStringId* hcc_ast_file_unique_included_files(HccASTFile* file, uint32_t* count_out);

void hcc_ast_file_reset(HccASTFile* file);
HccResult hcc_ast_file_push_token(HccASTFile* file, HccATAToken token, HccLocation* location);
HccResult hcc_ast_file_push_value(HccASTFile* file, HccATAValue value);
bool hcc_ast_file_pop_token(HccASTFile* file);

// ===========================================
//
//
// AST - Abstract Syntax Tree
//
//
// ===========================================

typedef struct HccAST HccAST;

typedef struct HccASTSetup HccASTSetup;
struct HccASTSetup {
	uint32_t        files_cap;
	HccASTFileSetup file_setup;
	uint32_t        exprs_grow_count;
	uint32_t        exprs_reserve_cap;
	uint32_t        expr_locations_grow_count;
	uint32_t        expr_locations_reserve_cap;
	uint32_t        global_variables_grow_count;
	uint32_t        global_variables_reserve_cap;
	uint32_t        forward_declarations_grow_count;
	uint32_t        forward_declarations_reserve_cap;
	uint32_t        designated_initializer_elmt_indices_grow_count;
	uint32_t        designated_initializer_elmt_indices_reserve_cap;
};

// ===========================================
//
//
// AML Operation
//
//
// ===========================================

typedef struct HccAMLFunction HccAMLFunction;

enum {
	HCC_AML_OP_NO_OP,

	//
	// memory access
	HCC_AML_OP_PTR_STATIC_ALLOC,
	HCC_AML_OP_PTR_LOAD,
	HCC_AML_OP_PTR_STORE,
	HCC_AML_OP_PTR_ACCESS_CHAIN,
	HCC_AML_OP_PTR_ACCESS_CHAIN_IN_BOUNDS,

	//
	// composite operations
	HCC_AML_OP_COMPOSITE_INIT,
	HCC_AML_OP_COMPOSITE_ACCESS_CHAIN_GET,
	HCC_AML_OP_COMPOSITE_ACCESS_CHAIN_SET,

	//
	// branching
	HCC_AML_OP_BASIC_BLOCK,
	HCC_AML_OP_BRANCH,
	HCC_AML_OP_BRANCH_CONDITIONAL,
	HCC_AML_OP_SWITCH,

	//
	// binary arithmetic, for AML intrinsic scalar or vector types
	HCC_AML_OP_ADD,
	HCC_AML_OP_SUBTRACT,
	HCC_AML_OP_MULTIPLY,
	HCC_AML_OP_DIVIDE,
	HCC_AML_OP_MODULO,
	HCC_AML_OP_BIT_AND,
	HCC_AML_OP_BIT_OR,
	HCC_AML_OP_BIT_XOR,
	HCC_AML_OP_BIT_SHIFT_LEFT,
	HCC_AML_OP_BIT_SHIFT_RIGHT,

	//
	// binary comparisions, for AML intrinsic scalar or vector types
	HCC_AML_OP_EQUAL,
	HCC_AML_OP_NOT_EQUAL,
	HCC_AML_OP_LESS_THAN,
	HCC_AML_OP_LESS_THAN_OR_EQUAL,
	HCC_AML_OP_GREATER_THAN,
	HCC_AML_OP_GREATER_THAN_OR_EQUAL,

	//
	// unary operations, for AML intrinsic scalar or vector types
	HCC_AML_OP_NEGATE,

	//
	// conversion
	HCC_AML_OP_CONVERT,
	HCC_AML_OP_BITCAST,

	//
	// misc
	HCC_AML_OP_CALL,
	HCC_AML_OP_RETURN,
	HCC_AML_OP_UNREACHABLE,
	HCC_AML_OP_SELECT,

	//
	// shader specific
	HCC_AML_OP_SELECTION_MERGE,
	HCC_AML_OP_LOOP_MERGE,
	HCC_AML_OP_RESOURCE_DESCRIPTOR_LOAD,
	HCC_AML_OP_RESOURCE_DESCRIPTOR_ADDR,

	//
	// scalar and vector
	HCC_AML_OP_MIN,
	HCC_AML_OP_MAX,
	HCC_AML_OP_CLAMP,
	HCC_AML_OP_SIGN,
	HCC_AML_OP_ABS,

	//
	// integer scalar and vector
	HCC_AML_OP_BITLSB,
	HCC_AML_OP_BITMSB,
	HCC_AML_OP_BITCOUNT,

	//
	// floating point scalar and vector
	HCC_AML_OP_FMA,
	HCC_AML_OP_FLOOR,
	HCC_AML_OP_CEIL,
	HCC_AML_OP_ROUND,
	HCC_AML_OP_TRUNC,
	HCC_AML_OP_FRACT,
	HCC_AML_OP_RADIANS,
	HCC_AML_OP_DEGREES,
	HCC_AML_OP_STEP,
	HCC_AML_OP_SMOOTHSTEP,
	HCC_AML_OP_SIN,
	HCC_AML_OP_COS,
	HCC_AML_OP_TAN,
	HCC_AML_OP_ASIN,
	HCC_AML_OP_ACOS,
	HCC_AML_OP_ATAN,
	HCC_AML_OP_SINH,
	HCC_AML_OP_COSH,
	HCC_AML_OP_TANH,
	HCC_AML_OP_ASINH,
	HCC_AML_OP_ACOSH,
	HCC_AML_OP_ATANH,
	HCC_AML_OP_ATAN2,
	HCC_AML_OP_POW,
	HCC_AML_OP_EXP,
	HCC_AML_OP_LOG,
	HCC_AML_OP_EXP2,
	HCC_AML_OP_LOG2,
	HCC_AML_OP_SQRT,
	HCC_AML_OP_RSQRT,
	HCC_AML_OP_ISINF,
	HCC_AML_OP_ISNAN,
	HCC_AML_OP_LERP,

	//
	// vector
	HCC_AML_OP_ANY,
	HCC_AML_OP_ALL,
	HCC_AML_OP_CROSS,
	HCC_AML_OP_DOT,
	HCC_AML_OP_LEN,
	HCC_AML_OP_NORM,
	HCC_AML_OP_REFLECT,
	HCC_AML_OP_REFRACT,
	HCC_AML_OP_SHUFFLE,

	//
	// vector un/packing ops
	HCC_AML_OP_PACK_F16X2_F32X2,
	HCC_AML_OP_UNPACK_F16X2_F32X2,
	HCC_AML_OP_PACK_U16X2_F32X2,
	HCC_AML_OP_UNPACK_U16X2_F32X2,
	HCC_AML_OP_PACK_S16X2_F32X2,
	HCC_AML_OP_UNPACK_S16X2_F32X2,
	HCC_AML_OP_PACK_U8X4_F32X4,
	HCC_AML_OP_UNPACK_U8X4_F32X4,
	HCC_AML_OP_PACK_S8X4_F32X4,
	HCC_AML_OP_UNPACK_S8X4_F32X4,

	//
	// pixel intrinsics
	HCC_AML_OP_DISCARD_PIXEL,
	HCC_AML_OP_DDX,
	HCC_AML_OP_DDY,
	HCC_AML_OP_FWIDTH,
	HCC_AML_OP_DDX_FINE,
	HCC_AML_OP_DDY_FINE,
	HCC_AML_OP_FWIDTH_FINE,
	HCC_AML_OP_DDX_COARSE,
	HCC_AML_OP_DDY_COARSE,
	HCC_AML_OP_FWIDTH_COARSE,

	//
	// wave intrinsics
	HCC_AML_OP_QUAD_SWAP_X,
	HCC_AML_OP_QUAD_SWAP_Y,
	HCC_AML_OP_QUAD_SWAP_DIAGONAL,
	HCC_AML_OP_QUAD_READ_THREAD,
	HCC_AML_OP_QUAD_ANY,
	HCC_AML_OP_QUAD_ALL,
	HCC_AML_OP_WAVE_IS_FIRST_LANE,
	HCC_AML_OP_WAVE_THREAD_IDX,
	HCC_AML_OP_WAVE_ACTIVE_ANY,
	HCC_AML_OP_WAVE_ACTIVE_ALL,
	HCC_AML_OP_WAVE_READ_THREAD,
	HCC_AML_OP_WAVE_ACTIVE_ALL_EQUAL,
	HCC_AML_OP_WAVE_ACTIVE_MIN,
	HCC_AML_OP_WAVE_ACTIVE_MAX,
	HCC_AML_OP_WAVE_ACTIVE_SUM,
	HCC_AML_OP_WAVE_ACTIVE_PREFIX_SUM,
	HCC_AML_OP_WAVE_ACTIVE_PRODUCT,
	HCC_AML_OP_WAVE_ACTIVE_PREFIX_PRODUCT,
	HCC_AML_OP_WAVE_ACTIVE_COUNT_BITS,
	HCC_AML_OP_WAVE_ACTIVE_PREFIX_COUNT_BITS,
	HCC_AML_OP_WAVE_ACTIVE_BIT_AND,
	HCC_AML_OP_WAVE_ACTIVE_BIT_OR,
	HCC_AML_OP_WAVE_ACTIVE_BIT_XOR,

	HCC_AML_OP_MEMORY_BARRIER_RESOURCE,
	HCC_AML_OP_MEMORY_BARRIER_DISPATCH_GROUP,
	HCC_AML_OP_MEMORY_BARRIER_ALL,
	HCC_AML_OP_CONTROL_BARRIER_RESOURCE,
	HCC_AML_OP_CONTROL_BARRIER_DISPATCH_GROUP,
	HCC_AML_OP_CONTROL_BARRIER_ALL,

	HCC_AML_OP_HPRINT_STRING,

	HCC_AML_OP_ATOMIC_LOAD,
	HCC_AML_OP_ATOMIC_STORE,
	HCC_AML_OP_ATOMIC_EXCHANGE,
	HCC_AML_OP_ATOMIC_COMPARE_EXCHANGE,
	HCC_AML_OP_ATOMIC_ADD,
	HCC_AML_OP_ATOMIC_SUB,
	HCC_AML_OP_ATOMIC_MIN,
	HCC_AML_OP_ATOMIC_MAX,
	HCC_AML_OP_ATOMIC_BIT_AND,
	HCC_AML_OP_ATOMIC_BIT_OR,
	HCC_AML_OP_ATOMIC_BIT_XOR,

	//
	// texture
	HCC_AML_OP_LOAD_TEXTURE,
	HCC_AML_OP_FETCH_TEXTURE,
	HCC_AML_OP_SAMPLE_TEXTURE,
	HCC_AML_OP_SAMPLE_MIP_BIAS_TEXTURE,
	HCC_AML_OP_SAMPLE_MIP_GRADIENT_TEXTURE,
	HCC_AML_OP_SAMPLE_MIP_LEVEL_TEXTURE,
	HCC_AML_OP_GATHER_RED_TEXTURE,
	HCC_AML_OP_GATHER_GREEN_TEXTURE,
	HCC_AML_OP_GATHER_BLUE_TEXTURE,
	HCC_AML_OP_GATHER_ALPHA_TEXTURE,
	HCC_AML_OP_STORE_TEXTURE,
	HCC_AML_OP_ADDR_TEXTURE,

	HCC_AML_OP_LOAD_BYTE_BUFFER,
	HCC_AML_OP_STORE_BYTE_BUFFER,

	HCC_AML_OP_COUNT,
};

extern const char* hcc_aml_op_code_strings[HCC_AML_OP_COUNT];
extern bool hcc_aml_op_code_has_return_value[HCC_AML_OP_COUNT];

// ===========================================
//
//
// AML Instruction
//
//
// ===========================================

typedef uint32_t HccAMLWord;
typedef HccAMLWord HccAMLInstr;
#define HCC_AML_INSTR(op, operands_count)       (((HccAMLWord)(op) << 16) | (operands_count))
#define HCC_AML_INSTR_OP(instr_ptr)             (*(instr_ptr) >> 16)
#define HCC_AML_INSTR_WORDS_COUNT(instr_ptr)    (HCC_AML_INSTR_OPERANDS_COUNT(instr_ptr) + 2)
#define HCC_AML_INSTR_OPERANDS_COUNT(instr_ptr) (*(instr_ptr) & 0xffff)
#define HCC_AML_INSTR_LOCATION_IDX(instr_ptr)   ((instr_ptr)[1])
#define HCC_AML_INSTR_OPERANDS(instr_ptr)       (&(instr_ptr)[2])

// ===========================================
//
//
// AML Operand
//
//
// ===========================================

//
// inherits HccDataType & HccDecl
typedef HccAMLWord HccAMLOperand;
enum {
	HCC_AML_OPERAND_VALUE = HCC_DECL_COUNT,
	HCC_AML_OPERAND_CONSTANT,
	HCC_AML_OPERAND_BASIC_BLOCK,
	HCC_AML_OPERAND_BASIC_BLOCK_PARAM,

	HCC_AML_OPERAND_COUNT,
};
#define HCC_AML_OPERANDS_TO_INSTR(operands_ptr) (&(operands_ptr)[-2])

static_assert(HCC_AML_OPERAND_COUNT <= HCC_DATA_TYPE_TYPE_MASK + 1, "HccDecl type overflows the type mask in HccDataType");

#define HCC_AML_OPERAND_TYPE(operand) HCC_DATA_TYPE_TYPE(operand)
#define HCC_AML_OPERAND_AUX(operand) HCC_DATA_TYPE_AUX(operand)
#define HCC_AML_OPERAND_IS_DATA_TYPE(operand) (HCC_AML_OPERAND_TYPE(operand) < HCC_DATA_TYPE_COUNT)
#define HCC_AML_OPERAND_IS_DECL(operand) (HCC_AML_OPERAND_TYPE(operand) < HCC_DECL_COUNT)
#define HCC_AML_OPERAND(type, aux) ( \
	HCC_AML_OPERAND_##type | \
	((aux) << HCC_DATA_TYPE_AUX_SHIFT) \
)

#define HCC_AML_OPERAND_IS_VALUE(operand) (HCC_AML_OPERAND_TYPE(operand) == HCC_AML_OPERAND_VALUE)
#define HCC_AML_OPERAND_IS_CONSTANT(operand) (HCC_AML_OPERAND_TYPE(operand) == HCC_AML_OPERAND_CONSTANT)
#define HCC_AML_OPERAND_IS_BASIC_BLOCK(operand) (HCC_AML_OPERAND_TYPE(operand) == HCC_AML_OPERAND_BASIC_BLOCK)
#define HCC_AML_OPERAND_IS_BASIC_BLOCK_PARAM(operand) (HCC_AML_OPERAND_TYPE(operand) == HCC_AML_OPERAND_BASIC_BLOCK_PARAM)

#define HCC_AML_ENTRY_BASIC_BLOCK_OPERAND HCC_AML_OPERAND(BASIC_BLOCK, 0)

HccDataType hcc_aml_operand_data_type(HccCU* cu, const HccAMLFunction* function, HccAMLOperand operand);

// ===========================================
//
//
// AML - Abstract Machine Language
//
//
// ===========================================

typedef struct HccAML HccAML;

typedef struct HccAMLValue HccAMLValue;
struct HccAMLValue {
	HccDataType data_type;
};

typedef struct HccAMLBasicBlock HccAMLBasicBlock;
struct HccAMLBasicBlock {
	uint32_t word_idx;
	uint32_t terminating_instr_word_idx; // basic blocks will always end in any HCC_AML_OP_BRANCH or HCC_AML_OP_RETURN like instruction
	uint16_t params_start_idx;
	uint16_t params_count;
};

typedef struct HccAMLBasicBlockParam HccAMLBasicBlockParam;
struct HccAMLBasicBlockParam {
	HccDataType data_type;
	uint16_t    srcs_start_idx;
	uint16_t    srcs_count;
};

typedef struct HccAMLBasicBlockParamSrc HccAMLBasicBlockParamSrc;
struct HccAMLBasicBlockParamSrc {
	HccAMLOperand basic_block_operand;
	HccAMLOperand operand;
};

typedef struct HccAMLFunctionAlctorSetup HccAMLFunctionAlctorSetup;
struct HccAMLFunctionAlctorSetup {
	uint32_t functions_grow_count;
	uint32_t functions_reserve_cap;
	uint32_t instrs_grow_count;
	uint32_t instrs_reserve_cap;
};

typedef struct HccAMLSetup HccAMLSetup;
struct HccAMLSetup {
	HccAMLFunctionAlctorSetup function_alctor;
};

const HccAMLFunction* hcc_aml_function_get(HccCU* cu, HccDecl decl);

uint32_t hcc_aml_function_words_count(HccAMLFunction* function);
HccAMLWord* hcc_aml_function_words(HccAMLFunction* function);

uint32_t hcc_aml_function_values_count(HccAMLFunction* function);
HccAMLValue* hcc_aml_function_values(HccAMLFunction* function);

uint32_t hcc_aml_function_basic_blocks_count(HccAMLFunction* function);
HccAMLBasicBlock* hcc_aml_function_basic_blocks(HccAMLFunction* function);

uint32_t hcc_aml_function_basic_block_params_count(HccAMLFunction* function);
HccAMLBasicBlockParam* hcc_aml_function_basic_block_params(HccAMLFunction* function);

uint32_t hcc_aml_function_basic_block_param_srcs_count(HccAMLFunction* function);
HccAMLBasicBlockParamSrc* hcc_aml_function_basic_block_param_srcs(HccAMLFunction* function);

// ===========================================
//
//
// AML Iterator
//
//
// ===========================================

typedef struct HccAMLInstrIter HccAMLInstrIter;
struct HccAMLInstrIter {
	HccAMLWord*       words;
	HccAMLValue*      values;
	HccAMLBasicBlock* basic_blocks;
	uint32_t          words_count;
	uint32_t          values_count;
	uint32_t          basic_blocks_count;
	uint32_t          next_word_idx;
};

HccAMLInstrIter hcc_aml_instr_iter(HccDecl decl);
bool hcc_aml_instr_iter_next(HccAMLInstrIter* iter, uint32_t* instr_word_idx);

// ===========================================
//
//
// Compilation Unit
//
//
// ===========================================
//
// this is not a traditional compiliation unit from the sense
// of a single C source file and all of it's includes.
// we actually allow multiple C source files to be compiled
// into a single AST and therefore a single binary.
//

typedef struct HccCU HccCU;

typedef struct HccCUSetup HccCUSetup;
struct HccCUSetup {
	HccDataTypeTableSetup dtt;
	HccConstantTableSetup constant_table;
	HccASTSetup           ast;
	HccAMLSetup           aml;
	uint32_t              functions_grow_count;
	uint32_t              functions_reserve_cap;
	uint32_t              function_params_and_variables_grow_count;
	uint32_t              function_params_and_variables_reserve_cap;
};

HccDataTypeTable* hcc_cu_get_data_type_table(HccCU* cu);
HccAST* hcc_cu_get_ast(HccCU* cu);
HccAML* hcc_cu_get_aml(HccCU* cu);

// ===========================================
//
//
// Compiler Target
//
//
// ===========================================

typedef uint16_t HccTargetArch;
enum HccTargetArch {
	HCC_TARGET_ARCH_X86_64,

	HCC_TARGET_ARCH_COUNT,
};

typedef uint16_t HccTargetOS;
enum HccTargetOS {
	HCC_TARGET_OS_LINUX,
	HCC_TARGET_OS_MAC_OS,
	HCC_TARGET_OS_WINDOWS,
	HCC_TARGET_OS_ANDROID,
	HCC_TARGET_OS_IOS,

	HCC_TARGET_OS_COUNT,
};

typedef uint16_t HccTargetGfxAPI;
enum HccTargetGfxAPI {
	HCC_TARGET_GFX_API_OPENGL,
	HCC_TARGET_GFX_API_VULKAN,
	HCC_TARGET_GFX_API_DX11,
	HCC_TARGET_GFX_API_DX12,
	HCC_TARGET_GFX_API_METAL,

	HCC_TARGET_GFX_API_COUNT,
};

typedef uint16_t HccTargetFormat;
enum HccTargetFormat {
	HCC_TARGET_FORMAT_SPIRV,
	HCC_TARGET_FORMAT_DXIL,
	HCC_TARGET_FORMAT_METAL,
	HCC_TARGET_FORMAT_GLSL,
	HCC_TARGET_FORMAT_HLSL,

	HCC_TARGET_FORMAT_COUNT,
};

typedef uint8_t HccOptLevel;
enum HccOptLevel {
	HCC_OPT_LEVEL_0,
	HCC_OPT_LEVEL_1,
	HCC_OPT_LEVEL_2,
	HCC_OPT_LEVEL_3,
	HCC_OPT_LEVEL_S, // small
	HCC_OPT_LEVEL_G, // debugging

	HCC_OPT_LEVEL_COUNT,
};

// ===========================================
//
//
// Compiler Options
//
//
// ===========================================

typedef struct HccOptions HccOptions;
typedef uint16_t HccOptionKey;
enum HccOptionKey {
	HCC_OPTION_KEY_TARGET_ARCH,                 // HccTargetArch
	HCC_OPTION_KEY_TARGET_OS,                   // HccTargetOS
	HCC_OPTION_KEY_TARGET_GFX_API,              // HccTargetGfxAPI
	HCC_OPTION_KEY_TARGET_FORMAT,               // HccTargetFormat
	HCC_OPTION_KEY_INT8_ENABLED,                // bool
	HCC_OPTION_KEY_INT16_ENABLED,               // bool
	HCC_OPTION_KEY_INT64_ENABLED,               // bool
	HCC_OPTION_KEY_FLOAT16_ENABLED,             // bool
	HCC_OPTION_KEY_FLOAT64_ENABLED,             // bool
	HCC_OPTION_KEY_PHYSICAL_POINTER_ENABLED,    // bool
	HCC_OPTION_KEY_BUNDLED_CONSTANTS_MAX_SIZE,  // uint
	HCC_OPTION_KEY_RESOURCE_DESCRIPTORS_MAX,    // uint
	HCC_OPTION_KEY_SHADER_ENUM_NAME,            // string
	HCC_OPTION_KEY_SHADER_ENUM_PREFIX,          // string
	HCC_OPTION_KEY_SHADER_INFOS_NAME,           // string
	HCC_OPTION_KEY_RESOURCE_STRUCTS_ENUM_NAME,  // string
	HCC_OPTION_KEY_RESOURCE_STRUCTS_ENUM_PREFIX,// string
	HCC_OPTION_KEY_SPIRV_OPT,                   // bool
	HCC_OPTION_KEY_HLSL_PACKING,                // bool
	HCC_OPTION_KEY_UNORDERED_SWIZZLING_ENABLED, // bool

	HCC_OPTION_KEY_COUNT,
};

typedef union HccOptionValue HccOptionValue;
union HccOptionValue {
	bool      bool_;
	uint32_t  uint;
	int32_t   int_;
	float     float_;
	HccString string;
};

typedef struct HccOptionsSetup HccOptionsSetup;
struct HccOptionsSetup {
	uint32_t defines_grow_count;
	uint32_t defines_reserve_cap;
};

extern HccOptionsSetup hcc_options_setup_default;
extern HccOptionValue hcc_option_key_defaults[HCC_OPTION_KEY_COUNT];

HccResult hcc_options_init(HccOptionsSetup* setup, HccOptions** o_out);
void hcc_options_deinit(HccOptions* options);
void hcc_options_reset(HccOptions* options);
HccResult hcc_options_merge(HccOptions* low_priority, HccOptions* high_priority, HccOptions** o_out);
HccResult hcc_options_clone(HccOptions* src, HccOptions** o_out);
bool hcc_options_is_set(HccOptions* options, HccOptionKey key);

HccOptionValue hcc_options_get(HccOptions* options, HccOptionKey key);
bool hcc_options_get_bool(HccOptions* options, HccOptionKey key);
uint32_t hcc_options_get_u32(HccOptions* options, HccOptionKey key);
int32_t hcc_options_get_s32(HccOptions* options, HccOptionKey key);
float hcc_options_get_float(HccOptions* options, HccOptionKey key);
HccString hcc_options_get_string(HccOptions* options, HccOptionKey key);

void hcc_options_set(HccOptions* options, HccOptionKey key, HccOptionValue value);
void hcc_options_set_bool(HccOptions* options, HccOptionKey key, bool value);
void hcc_options_set_u32(HccOptions* options, HccOptionKey key, uint32_t value);
void hcc_options_set_s32(HccOptions* options, HccOptionKey key, int32_t value);
void hcc_options_set_float(HccOptions* options, HccOptionKey key, float value);
void hcc_options_set_string(HccOptions* options, HccOptionKey key, HccString value);

HccResult hcc_options_add_define(HccOptions* options, HccString name, HccString value);

bool hcc_options_is_char_unsigned(HccOptions* o);

// ===========================================
//
//
// Compiler Task
//
//
// ===========================================

typedef uint8_t HccWorkerJobType;
enum HccWorkerJobType {
	HCC_WORKER_JOB_TYPE_ATAGEN,      // CODE -> ATA
	HCC_WORKER_JOB_TYPE_ASTGEN,      // ATA -> AST
	HCC_WORKER_JOB_TYPE_ASTLINK,     // AST -> AST (linked)
	HCC_WORKER_JOB_TYPE_AMLGEN,      // AST -> AML (per function)
	HCC_WORKER_JOB_TYPE_AMLOPT,      // AML -> AML (optimized) (per function and per optimization)
	HCC_WORKER_JOB_TYPE_BACKENDGEN,  // AML -> Target (per function)
	HCC_WORKER_JOB_TYPE_BACKENDLINK, // Build Target Binary

	HCC_WORKER_JOB_TYPE_COUNT,
};

typedef struct HccTaskSetup HccTaskSetup;
struct HccTaskSetup {
	HccCUSetup       cu;
	HccOptions*      options;
	uint32_t         include_paths_cap;
	uint32_t         messages_cap;
	uint32_t         message_strings_cap;
};

typedef struct HccTask HccTask;

extern HccTaskSetup hcc_task_setup_default;
extern const char* hcc_worker_job_type_strings[HCC_WORKER_JOB_TYPE_COUNT];

HccResult hcc_task_init(HccTaskSetup* setup, HccTask** t_out);
void hcc_task_deinit(HccTask* t);

void hcc_task_set_final_worker_job_type(HccTask* t, HccWorkerJobType final_worker_job_type);

HccResult hcc_task_add_include_path(HccTask* t, HccString path);
HccResult hcc_task_add_input_code_file(HccTask* t, const char* file_path, HccOptions* options);

HccResult hcc_task_add_output_ast_text(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_ast_binary(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_ast(HccTask* t, HccAST** ast_out);

HccResult hcc_task_add_output_aml_text(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_aml_binary(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_aml(HccTask* t, HccAML** aml_out);

HccResult hcc_task_add_output_binary(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_metadata_c(HccTask* t, HccIIO* iio);
HccResult hcc_task_add_output_metadata_json(HccTask* t, HccIIO* iio);

bool hcc_task_has_started(HccTask* t);
bool hcc_task_is_complete(HccTask* t);
HccResult hcc_task_result(HccTask* t);
HccMessage* hcc_task_messages(HccTask* t, uint32_t* count_out);
HccCU* hcc_task_cu(HccTask* t);
HccResult hcc_task_wait_for_complete(HccTask* t);
HccDuration hcc_task_duration(HccTask* t); // total duration from when the task started, must be called when the task is complete
HccDuration hcc_task_worker_job_type_duration(HccTask* t, HccWorkerJobType type); // duration spent on the task by the workers for this job type, must be called when the task is complete

// ===========================================
//
//
// Compiler
//
//
// ===========================================

typedef struct HccPPGenSetup HccPPGenSetup;
struct HccPPGenSetup {
	uint32_t expand_stack_grow_count;
	uint32_t expand_stack_reserve_cap;
	uint32_t stringify_buffer_grow_count;
	uint32_t stringify_buffer_reserve_cap;
	uint32_t if_stack_grow_count;
	uint32_t if_stack_reserve_cap;
	uint32_t macro_declarations_cap;
	uint32_t macro_args_stack_grow_count;
	uint32_t macro_args_stack_reserve_cap;
};

typedef struct HccATAGenSetup HccATAGenSetup;
struct HccATAGenSetup {
	HccPPGenSetup ppgen;
	uint32_t      paused_file_stack_grow_count;
	uint32_t      paused_file_stack_reserve_cap;
	uint32_t      open_bracket_stack_grow_count;
	uint32_t      open_bracket_stack_reserve_cap;
};

typedef struct HccASTGenSetup HccASTGenSetup;
struct HccASTGenSetup {
	uint32_t variable_stack_grow_count;
	uint32_t variable_stack_reserve_cap;
	uint32_t compound_fields_reserve_cap;
	uint32_t function_params_and_variables_reserve_cap;
	uint32_t enum_values_reserve_cap;
	uint32_t curly_initializer_nested_reserve_cap;
	uint32_t curly_initializer_nested_curlys_reserve_cap;
	uint32_t curly_initializer_nested_elmts_reserve_cap;
	uint32_t curly_initializer_composite_constant_ids_grow_count;
	uint32_t curly_initializer_composite_constant_ids_reserve_cap;
};

typedef struct HccASTLinkSetup HccASTLinkSetup;
struct HccASTLinkSetup {
	uint32_t __placeholder__;
};

typedef struct HccAMLGenSetup HccAMLGenSetup;
struct HccAMLGenSetup {
	uint32_t placeholder;
};

typedef struct HccBackendLinkSetup HccBackendLinkSetup;
struct HccBackendLinkSetup {
	uint32_t binary_grow_size;
	uint32_t binary_reserve_size;
};

typedef struct HccCompilerSetup HccCompilerSetup;
struct HccCompilerSetup {
	HccATAGenSetup      atagen;
	HccASTGenSetup      astgen;
	HccASTLinkSetup     astlink;
	HccAMLGenSetup      amlgen;
	HccBackendLinkSetup backendlink;
	uint32_t            worker_string_buffer_grow_size;
	uint32_t            worker_string_buffer_reserve_size;
	uint32_t            worker_arena_size;
	uint32_t            workers_count;
	uint32_t            worker_jobs_queue_cap;
	uint32_t            worker_call_stack_size;
};

extern HccCompilerSetup hcc_compiler_setup_default;

HccResult hcc_compiler_init(HccCompilerSetup* setup, HccCompiler** c_out);
HccResult hcc_compiler_deinit(HccCompiler* c);
HccResult hcc_compiler_dispatch_task(HccCompiler* c, HccTask* t);
HccResult hcc_compiler_wait_for_all_tasks(HccCompiler* c);
HccResult hcc_compiler_clear_mem_arenas(HccCompiler* c);
HccDuration hcc_compiler_duration(HccCompiler* c); // total duration from when the compiler started, must be called when the compiler is complete
HccDuration hcc_compiler_worker_job_type_duration(HccCompiler* c, HccWorkerJobType type); // duration spent on the compiler by the workers for this job type, must be called when the compiler is complete

// ===========================================
//
//
// String Table
//
//
// ===========================================
//
// used to hold a unique set of strings so the user
// can reduce the string down to a uint32_t identifier.
// this identifier can be used to uniquely identify the string.
// so a comparision with the two identifier integers can be used to compare strings.
//

typedef struct HccStringTable HccStringTable;

#define hcc_string_table_deduplicate_lit(string_lit, out) hcc_string_table_deduplicate(string_lit, sizeof(string_lit) - 1, out)
#define hcc_string_table_deduplicate_c_string(c_string, out) hcc_string_table_deduplicate(c_string, strlen(c_string), out)
HccResult hcc_string_table_deduplicate(const char* string, uint32_t string_size, HccStringId* out);
HccString hcc_string_table_get(HccStringId id);
HccString hcc_string_table_get_or_empty(HccStringId id);

// ===========================================
//
//
// Code File
//
//
// ===========================================

typedef struct HccCodeFile HccCodeFile;

HccCodeFile* hcc_code_file_find(HccString file_path);
HccResult hcc_code_file_find_or_insert(HccString file_path, HccCodeFile** code_file_out);
HccString hcc_code_file_path_string(HccCodeFile* code_file);
HccString hcc_code_file_code(HccCodeFile* code_file);
uint32_t hcc_code_file_line_size(HccCodeFile* code_file, uint32_t line);
uint32_t hcc_code_file_lines_count(HccCodeFile* code_file);

// ===========================================
//
//
// Location
//
//
// ===========================================

typedef struct HccLocation HccLocation;
struct HccLocation {
	HccCodeFile* code_file;
	HccLocation* parent_location;
	HccPPMacro*  macro;
	uint32_t     code_start_idx;
	uint32_t     code_end_idx;
	uint32_t     line_start;
	uint32_t     line_end;
	uint32_t     column_start;
	uint32_t     column_end;

	HccString    display_path;
	uint32_t     display_line;
};

// ===========================================
//
//
// Library
//
//
// ===========================================

typedef uint32_t HccFlags;
enum HccFlags {
	HCC_FLAGS_NONE =              0x0,
	HCC_FLAGS_ENABLE_STACKTRACE = 0x1,
};

typedef uint32_t (*HccPathCanonicalizeFn)(const char* path, char* out_buf);
typedef bool (*HccFileOpenReadFn)(const char* path, HccIIO* out);

typedef struct HccSetup HccSetup;
struct HccSetup {
	HccFlags               flags;
	uint32_t               global_mem_arena_size;
	HccAllocEventFn        alloc_event_fn;
	HccPathCanonicalizeFn  path_canonicalize_fn;
	HccFileOpenReadFn      file_open_read_fn;
	void*                  alloc_event_userdata;
	uint32_t               string_table_data_grow_count;
	uint32_t               string_table_data_reserve_cap;
	uint32_t               string_table_entries_cap;
	uint32_t               code_files_cap;
	uint32_t               code_file_lines_grow_count;
	uint32_t               code_file_lines_reserve_cap;
	uint32_t               code_file_pp_if_spans_grow_count;
	uint32_t               code_file_pp_if_spans_reserve_cap;
};

extern HccSetup hcc_setup_default;

HccResult hcc_init(HccSetup* setup);
void hcc_deinit(void);
HccResult hcc_clear_global_mem_arena(void);
HccResult hcc_clear_code_files(void);
HccResult hcc_alloc_location(HccLocation** out);

